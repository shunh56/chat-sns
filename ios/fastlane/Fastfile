default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do |options|
    # 環境変数から環境を取得（dev/prod/appstore）
    environment = options[:env] || "dev"

    # アプリIDの設定
    app_identifier = "com.blank.sns"

    # 証明書とプロファイルの取得（Match使用）
    # 初回設定時はコメントアウトして手動で設定
    # match(type: "appstore", readonly: true)

    # ビルド番号の自動インクリメント
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "Runner.xcodeproj"
    )

    # Flutterビルド（Makefileのコマンドを使用）
    sh("cd ../.. && make build-#{environment}")

    # TestFlightへアップロード
    upload_to_testflight(
      ipa: "../../build/ios/ipa/*.ipa",
      skip_waiting_for_build_processing: true,
      changelog: "自動ビルド from #{environment} environment"
    )
  end

  desc "Build for Firebase App Distribution"
  lane :firebase do |options|
    # 環境変数から環境を取得（dev/prod）
    environment = options[:env] || "dev"

    # ビルド番号の自動インクリメント
    increment_build_number(
      build_number: Time.now.to_i,
      xcodeproj: "Runner.xcodeproj"
    )

    # DerivedDataをクリーン
    sh("rm -rf ~/Library/Developer/Xcode/DerivedData")

    # Flutter依存関係を取得してxcconfigファイルを生成
    sh("cd ../.. && flutter pub get")

    # pod installが既に実行されているか確認、なければ実行
    if !File.exist?("Runner.xcworkspace")
      sh("pod install --repo-update")
    end

    # Xcodeプロジェクトをクリーン
    sh("xcodebuild clean -workspace Runner.xcworkspace -scheme Runner -configuration Release || true")

    # Flutterビルド（設定のみ生成、実際のビルドはbuild_appに任せる）
    sh("cd ../.. && flutter build ios --release --dart-define-from-file=dart_defines/#{environment}.env --config-only")

    # build_app（gymのエイリアス）でビルド+署名+エクスポート
    # build_appはより新しいAPIで、自動署名のハンドリングが改善されている
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "ad-hoc",
      export_team_id: "CDQBCQRWL9",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "ad-hoc",
        teamID: "CDQBCQRWL9",
        signingStyle: "automatic",
        allowProvisioningUpdates: true,
        signingCertificate: "Apple Distribution",
        provisioningProfiles: {
          "com.blank.sns" => "Automatic"
        }
      }
    )

    # Firebase App Distributionへアップロード
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      ipa_path: lane_context[SharedValues::IPA_OUTPUT_PATH],
      groups: "testers",
      release_notes: "自動ビルド from #{environment} environment"
    )
  end

  desc "Setup certificates and provisioning profiles"
  lane :setup_certs do
    # Matchの初期設定（初回のみ実行）
    match(
      type: "development",
      app_identifier: "com.blank.sns",
      readonly: false
    )

    match(
      type: "adhoc",
      app_identifier: "com.blank.sns",
      readonly: false
    )

    match(
      type: "appstore",
      app_identifier: "com.blank.sns",
      readonly: false
    )
  end
end