default_platform(:ios)

# gRPCä¿®æ­£ã‚’é©ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
def apply_grpc_fixes
  require 'xcodeproj'

  begin
    UI.message("ğŸ” Searching for gRPC targets in project...")

    # Podsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
    unless Dir.exist?("Pods")
      UI.error("âŒ Pods directory not found. Skipping gRPC fixes.")
      return
    end

    # ç›´æ¥ãƒ“ãƒ«ãƒ‰è¨­å®šã‚’ä¿®æ­£
    result = sh('find Pods -name "*.xcconfig" -exec grep -l "gRPC\\|GRPC" {} \\; 2>/dev/null | head -10', log: false)

    if result.strip.empty?
      UI.important("âš ï¸ No gRPC xcconfig files found")
    else
      UI.message("ğŸ“ Found gRPC xcconfig files, applying C++17 fixes...")

      sh('find Pods -name "*.xcconfig" -exec grep -l "gRPC\\|GRPC" {} \\; 2>/dev/null | head -10 | while IFS= read -r file; do
        echo "ğŸ“ Patching $file"
        if ! grep -q "CLANG_CXX_LANGUAGE_STANDARD.*c++17" "$file" 2>/dev/null; then
          echo "CLANG_CXX_LANGUAGE_STANDARD = c++17" >> "$file"
        fi
        if ! grep -q "GCC_WARN_INHIBIT_ALL_WARNINGS.*YES" "$file" 2>/dev/null; then
          echo "GCC_WARN_INHIBIT_ALL_WARNINGS = YES" >> "$file"
        fi
        echo "âœ… Patched $file"
      done')
    end

    # ç›´æ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä¿®æ­£
    if File.exist?("Runner.xcworkspace")
      UI.message("ğŸ”§ Also applying direct project modifications...")
      project = Xcodeproj::Project.open("Runner.xcodeproj")

      project.targets.each do |target|
        if target.name.include?('Runner')
          target.build_configurations.each do |config|
            config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'
            config.build_settings['OTHER_CPLUSPLUSFLAGS'] ||= ['$(inherited)']
            config.build_settings['OTHER_CPLUSPLUSFLAGS'] << '-std=c++17' unless config.build_settings['OTHER_CPLUSPLUSFLAGS'].include?('-std=c++17')
            config.build_settings['OTHER_CPLUSPLUSFLAGS'] << '-Wno-error=c++20-extensions' unless config.build_settings['OTHER_CPLUSPLUSFLAGS'].include?('-Wno-error=c++20-extensions')
          end
        end
      end

      project.save
      UI.success("âœ… Applied project-level C++17 settings")
    end

    UI.success("âœ… Applied direct gRPC fixes to build configuration files")

  rescue => e
    UI.error("âŒ Failed to apply gRPC fixes: #{e.message}")
  end
end

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do |options|
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç’°å¢ƒã‚’å–å¾—ï¼ˆdev/prod/appstoreï¼‰
    environment = options[:env] || "dev"

    # ã‚¢ãƒ—ãƒªIDã®è¨­å®š
    app_identifier = "com.blank.sns"

    # è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ï¼ˆMatchä½¿ç”¨ï¼‰
    # åˆå›è¨­å®šæ™‚ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦æ‰‹å‹•ã§è¨­å®š
    # match(type: "appstore", readonly: true)

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã®è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "Runner.xcodeproj"
    )

    # Flutterãƒ“ãƒ«ãƒ‰ï¼ˆMakefileã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼‰
    sh("cd ../.. && make build-#{environment}")

    # TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
      ipa: "../../build/ios/ipa/*.ipa",
      skip_waiting_for_build_processing: true,
      changelog: "è‡ªå‹•ãƒ“ãƒ«ãƒ‰ from #{environment} environment"
    )
  end

  desc "Build for Firebase App Distribution"
  lane :firebase do |options|
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç’°å¢ƒã‚’å–å¾—ï¼ˆdev/prodï¼‰
    environment = options[:env] || "dev"

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã®è‡ªå‹•ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    increment_build_number(
      build_number: Time.now.to_i,
      xcodeproj: "Runner.xcodeproj"
    )

    # Matchã‚’è©¦è¡Œã™ã‚‹ãŒã€å¤±æ•—ã—ãŸå ´åˆã¯automatic signingã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    begin
      # MATCH_GIT_URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
      if !ENV["MATCH_GIT_URL"] || ENV["MATCH_GIT_URL"].empty?
        UI.important("MATCH_GIT_URL is not set. Skipping Match and using automatic signing.")
        raise "No MATCH_GIT_URL"
      end

      UI.message("Attempting to use Fastlane Match for certificate management...")

      # Matchã§è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸï¼ˆAPI Keyèªè¨¼ã§ï¼‰
      match(
        type: "adhoc",
        app_identifier: "com.blank.sns",
        readonly: true,
        git_url: ENV["MATCH_GIT_URL"],
        api_key_path: File.expand_path("~/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8"),
        api_key: {
          key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
          issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
          key: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
          in_house: false
        }
      )

      UI.success("âœ… Fastlane Match completed successfully!")

    rescue => e
      UI.important("âš ï¸  Fastlane Match failed: #{e.message}")
      UI.important("Falling back to automatic signing with App Store Connect API Key...")

      # API Keyæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼ˆautomatic signingã§ä½¿ç”¨ï¼‰
      ENV["APP_STORE_CONNECT_API_KEY_PATH"] = File.expand_path("~/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8")
    end

    # Flutter iOS ãƒ“ãƒ«ãƒ‰ï¼ˆç½²åãªã—ï¼‰
    sh("cd ../.. && flutter build ios --release --dart-define-from-file=dart_defines/#{environment}.env --no-codesign")

    # gRPCä¿®æ­£ã‚’å†é©ç”¨ï¼ˆFlutter buildã§pod installãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œï¼‰
    UI.message("ğŸ”§ Re-applying gRPC C++17 fixes after Flutter build...")
    apply_grpc_fixes

    # gymã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–+ç½²å+ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆallowProvisioningUpdatesã‚’ä½¿ç”¨ï¼‰
    gym(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      configuration: "Release",
      export_method: "ad-hoc",
      xcargs: "-allowProvisioningUpdates CODE_SIGN_STYLE=Automatic DEVELOPMENT_TEAM=CDQBCQRWL9",
      export_options: {
        signingStyle: "automatic",
        teamID: "CDQBCQRWL9",
        allowProvisioningUpdates: true
      },
      output_directory: "../../build/ios/ipa",
      output_name: "Runner.ipa"
    )

    # Firebase App Distributionã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      ipa_path: lane_context[SharedValues::IPA_OUTPUT_PATH],
      groups: "testers",
      release_notes: "è‡ªå‹•ãƒ“ãƒ«ãƒ‰ from #{environment} environment"
    )
  end

  desc "Setup certificates and provisioning profiles"
  lane :setup_certs do
    # Matchã®åˆæœŸè¨­å®šï¼ˆåˆå›ã®ã¿å®Ÿè¡Œï¼‰
    match(
      type: "development",
      app_identifier: "com.blank.sns",
      readonly: false
    )

    match(
      type: "adhoc",
      app_identifier: "com.blank.sns",
      readonly: false
    )

    match(
      type: "appstore",
      app_identifier: "com.blank.sns",
      readonly: false
    )
  end
end