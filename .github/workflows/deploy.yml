name: Deploy to TestFlight & Firebase (Optimized)

on:
  push:
    branches: [ develop ]
  pull_request:
    types: [ closed ]
    branches: [ main ]

env:
  FLUTTER_VERSION: '3.24.3'

jobs:
  # ‰∏¶ÂàóÂÆüË°å„Åß„Éì„É´„ÉâÊôÇÈñì„ÇíÂçäÂàÜ„Å´
  deploy-ios:
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: macos-latest
    outputs:
      firebase_ios_url: ${{ steps.save-firebase-ios-url.outputs.url }}
      firebase_ios_url_encoded: ${{ steps.save-firebase-ios-url.outputs.url_encoded }}
      testflight_url: ${{ steps.save-testflight-url.outputs.url }}

    steps:
    - uses: actions/checkout@v4

    # üöÄ ÊîπÂñÑ1: Flutter + ‰æùÂ≠òÈñ¢‰øÇ„Ç≠„É£„ÉÉ„Ç∑„É•Âº∑Âåñ
    - name: Cache Flutter SDK
      uses: actions/cache@v3
      with:
        path: |
          /Users/runner/hostedtoolcache/flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    # üöÄ ÊîπÂñÑ2: pub‰æùÂ≠òÈñ¢‰øÇ„ÅÆÁ©çÊ•µÁöÑ„Ç≠„É£„ÉÉ„Ç∑„É•
    - name: Cache pub dependencies
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.PUB_CACHE }}
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: Install Flutter dependencies
      run: flutter pub get

    # CocoaPods„Ç≠„É£„ÉÉ„Ç∑„É•„ÅØÂâäÈô§ÔºàÂ∏∏„Å´„ÇØ„É™„Éº„É≥„Ç§„É≥„Çπ„Éà„Éº„É´Ôºâ
    # ÈáçË§á„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ„ÅÆÂïèÈ°å„ÇíÈÅø„Åë„Çã„Åü„ÇÅ

    - name: Setup Ruby & Fastlane (cached)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: ios

    - name: Install pods (with conflict resolution)
      run: |
        cd ios
        echo "üßπ Cleaning previous pod installation..."
        rm -rf Pods Podfile.lock .symlinks

        echo "üîÑ Installing fresh pods..."
        pod deintegrate || true
        pod repo update
        pod install --repo-update

        echo "‚úÖ Pods installed successfully"

    - name: Determine environment
      id: env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi

    # üöÄ ÊîπÂñÑ4: Ë®ºÊòéÊõ∏„Ç≠„É£„ÉÉ„Ç∑„É•
    - name: Cache signing certificates
      id: cert-cache
      uses: actions/cache@v3
      with:
        path: |
          certificate.p12
          build.keychain
        key: ios-cert-${{ hashFiles('ios/Runner.xcodeproj/project.pbxproj') }}-v1

    # Ë®ò‰∫ã„ÅÆÊàêÂäü‰æã„Å´Âü∫„Å•„ÅèÊîπÂñÑÔºöKeychain„ÅÆÈÅ©Âàá„Å™Ë®≠ÂÆöÔºàÊù°‰ª∂‰ªò„ÅçÂÆüË°åÔºâ
    - name: Setup Keychain and Certificates
      if: env.IOS_DISTRIBUTION_CERTIFICATE_BASE64 != ''
      env:
        CERTIFICATE_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        # Only run if certificate is provided
        if [ -z "$CERTIFICATE_BASE64" ]; then
          echo "‚ö†Ô∏è No certificate provided, skipping keychain setup"
          exit 0
        fi

        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

        # Store keychain path for cleanup
        echo "TEMP_KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

        # Decode certificates and profiles
        echo "$CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/distribution.p12
        echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > $RUNNER_TEMP/profile.mobileprovision

        # Create and configure keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate
        security import $RUNNER_TEMP/distribution.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $RUNNER_TEMP/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

        echo "‚úÖ Certificates and provisioning profiles configured"

    - name: Setup App Store Connect API Key
      env:
        API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      run: |
        # Create API Key directory
        mkdir -p ~/private_keys

        # Create API Key file
        echo "$API_KEY_CONTENT" > ~/private_keys/AuthKey_${API_KEY_ID}.p8

        # Set file permissions
        chmod 600 ~/private_keys/AuthKey_${API_KEY_ID}.p8

        # Export environment variables for xcodebuild
        echo "APP_STORE_CONNECT_API_KEY_ID=$API_KEY_ID" >> $GITHUB_ENV
        echo "APP_STORE_CONNECT_API_ISSUER_ID=$API_ISSUER_ID" >> $GITHUB_ENV
        echo "APP_STORE_CONNECT_API_KEY_PATH=$HOME/private_keys/AuthKey_${API_KEY_ID}.p8" >> $GITHUB_ENV

        echo "‚úÖ App Store Connect API Key configured"

    # üöÄ ÊîπÂñÑ5: FirebaseÈÖçÂ∏É„ÅÆ„ÅøÔºàdevelopÁî®Ôºâ
    - name: Deploy to Firebase App Distribution
      if: github.ref == 'refs/heads/develop'
      env:
        FIREBASE_APP_ID_IOS: ${{ secrets.FIREBASE_APP_ID_IOS_DEV }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      run: |
        cd ios
        bundle exec fastlane firebase env:${{ steps.env.outputs.environment }}

    # Firebase URL„ÇíÁí∞Â¢ÉÂ§âÊï∞„Å´‰øùÂ≠ò
    - name: Save Firebase iOS URL
      id: save-firebase-ios-url
      if: github.ref == 'refs/heads/develop' && always()
      run: |
        if [ -f "firebase_ios_url.txt" ]; then
          url=$(cat firebase_ios_url.txt)
          echo "‚úÖ Found iOS URL: $url"
          # Base64 encode to avoid secret masking by GitHub Actions
          encoded_url=$(echo -n "$url" | base64 -w 0)
          echo "url_encoded=$encoded_url" >> $GITHUB_OUTPUT
          echo "url=$url" >> $GITHUB_OUTPUT
        else
          echo "‚ùå firebase_ios_url.txt not found"
          echo "url_encoded=" >> $GITHUB_OUTPUT
          echo "url=No URL available" >> $GITHUB_OUTPUT
        fi

    # TestFlight„ÅØÊú¨Áï™„ÅÆ„ÅøÔºàÊôÇÈñìÁü≠Á∏ÆÔºâ
    - name: Deploy to TestFlight
      if: github.ref == 'refs/heads/main'
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        APP_STORE_CONNECT_APP_ID: ${{ secrets.APP_STORE_CONNECT_APP_ID }}
      run: |
        cd ios
        bundle exec fastlane beta env:${{ steps.env.outputs.environment }}

    # TestFlight URL„ÇíÁí∞Â¢ÉÂ§âÊï∞„Å´‰øùÂ≠ò
    - name: Save TestFlight URL
      id: save-testflight-url
      if: github.ref == 'refs/heads/main' && always()
      run: |
        if [ -f "testflight_url.txt" ]; then
          url=$(cat testflight_url.txt)
          echo "url=$url" >> $GITHUB_OUTPUT
        else
          echo "url=No URL available" >> $GITHUB_OUTPUT
        fi

  deploy-android:
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      firebase_android_url: ${{ steps.save-firebase-android-url.outputs.url }}
      firebase_android_url_encoded: ${{ steps.save-firebase-android-url.outputs.url_encoded }}
      google_play_url: ${{ steps.save-google-play-url.outputs.url }}

    steps:
    - uses: actions/checkout@v4

    # üöÄ ÊîπÂñÑ6: Flutter + Gradle „Ç≠„É£„ÉÉ„Ç∑„É•
    - name: Cache Flutter SDK
      uses: actions/cache@v3
      with:
        path: |
          /opt/hostedtoolcache/flutter
        key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Cache pub dependencies
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.PUB_CACHE }}
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    # üöÄ ÊîπÂñÑ7: Gradle + Android SDK „Ç≠„É£„ÉÉ„Ç∑„É•
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/avd/*
          ~/.android/adb*
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Setup Ruby & Fastlane (cached)
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        working-directory: android

    - name: Determine environment
      id: env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi

    - name: Decode Keystore
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > android/app/key.jks

    - name: Create key.properties
      env:
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
      run: |
        echo "storePassword=$ANDROID_STORE_PASSWORD" > android/key.properties
        echo "keyPassword=$ANDROID_KEY_PASSWORD" >> android/key.properties
        echo "keyAlias=$ANDROID_KEY_ALIAS" >> android/key.properties
        echo "storeFile=key.jks" >> android/key.properties

    # FirebaseÈÖçÂ∏É„ÅÆ„ÅøÔºàdevelopÔºâ
    - name: Deploy to Firebase App Distribution
      if: github.ref == 'refs/heads/develop'
      env:
        FIREBASE_APP_ID_ANDROID: ${{ secrets.FIREBASE_APP_ID_ANDROID_DEV }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        cd android
        bundle exec fastlane firebase env:${{ steps.env.outputs.environment }}

    # Firebase URL„ÇíÁí∞Â¢ÉÂ§âÊï∞„Å´‰øùÂ≠ò
    - name: Save Firebase Android URL
      id: save-firebase-android-url
      if: github.ref == 'refs/heads/develop' && always()
      run: |
        echo "üîç Looking for Firebase Android URL file..."
        echo "üìÇ Current directory: $(pwd)"
        echo "üìÅ Directory contents:"
        ls -la

        if [ -f "firebase_android_url.txt" ]; then
          url=$(cat firebase_android_url.txt)
          echo "‚úÖ Found URL: $url"
          # Base64 encode to avoid secret masking by GitHub Actions
          encoded_url=$(echo -n "$url" | base64 -w 0)
          echo "url_encoded=$encoded_url" >> $GITHUB_OUTPUT
          echo "url=$url" >> $GITHUB_OUTPUT
        else
          echo "‚ùå firebase_android_url.txt not found"
          echo "üîç Searching for URL file in subdirectories..."
          find . -name "*firebase*url*" -type f 2>/dev/null || echo "No Firebase URL files found"
          echo "url_encoded=" >> $GITHUB_OUTPUT
          echo "url=Firebase URL file not found" >> $GITHUB_OUTPUT
        fi

    # Google Play„ÅØÊú¨Áï™„ÅÆ„Åø
    - name: Deploy to Google Play Internal Testing
      if: github.ref == 'refs/heads/main'
      env:
        GOOGLE_PLAY_JSON_KEY_BASE64: ${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64 }}
      run: |
        echo $GOOGLE_PLAY_JSON_KEY_BASE64 | base64 --decode > android/play-store-key.json
        cd android
        bundle exec fastlane beta env:${{ steps.env.outputs.environment }}

    # Google Play URL„Çí‰øùÂ≠ò
    - name: Save Google Play URL
      id: save-google-play-url
      if: github.ref == 'refs/heads/main' && always()
      run: |
        echo "url=https://play.google.com/console/u/0/developers/${{ secrets.GOOGLE_PLAY_DEVELOPER_ID }}/app/${{ secrets.GOOGLE_PLAY_APP_ID }}/tracks/internal-testing" >> $GITHUB_OUTPUT

    # Keychain„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºàË®ò‰∫ã„ÅÆÊàêÂäü‰æã„Å´Âü∫„Å•„ÅèÔºâ
    - name: Cleanup keychain
      if: always() && env.TEMP_KEYCHAIN_PATH != ''
      run: |
        if [ -n "$TEMP_KEYCHAIN_PATH" ]; then
          security delete-keychain $TEMP_KEYCHAIN_PATH || true
        fi

  # üöÄ ÊîπÂñÑ8: ËªΩÈáè„Å™ÈÄöÁü•„Ç∏„Éß„Éñ
  notify-completion:
    needs: [deploy-ios, deploy-android]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Prepare Firebase URLs for Slack
      id: prepare-urls
      run: |
        # Use direct URLs since they're working now
        echo "firebase_ios_url=${{ needs.deploy-ios.outputs.firebase_ios_url || 'Not available' }}" >> $GITHUB_OUTPUT
        echo "firebase_android_url=${{ needs.deploy-android.outputs.firebase_android_url || 'Not available' }}" >> $GITHUB_OUTPUT

        # Debug output
        echo "iOS URL: ${{ needs.deploy-ios.outputs.firebase_ios_url || 'Not available' }}"
        echo "Android URL: ${{ needs.deploy-android.outputs.firebase_android_url || 'Not available' }}"

    - name: Slack Notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: custom
        custom_payload: |
          {
            text: "üöÄ Deployment completed!",
            attachments: [{
              color: '${{ needs.deploy-ios.result == 'success' && needs.deploy-android.result == 'success' && 'good' || 'danger' }}',
              fields: [{
                title: 'iOS Deploy',
                value: '${{ needs.deploy-ios.result }}',
                short: true
              }, {
                title: 'Android Deploy',
                value: '${{ needs.deploy-android.result }}',
                short: true
              }]
            }, {
              color: 'good',
              title: 'üì± Download Links',
              text: '${{ github.ref == 'refs/heads/develop' && format('üì≤ Firebase App Distribution\n‚Ä¢ iOS: {0}\n‚Ä¢ Android: {1}', steps.prepare-urls.outputs.firebase_ios_url || 'Not available', steps.prepare-urls.outputs.firebase_android_url || 'Not available') || format('üè™ Store Links\n‚Ä¢ TestFlight: {0}\n‚Ä¢ Google Play Internal: {1}', needs.deploy-ios.outputs.testflight_url || 'Not available', needs.deploy-android.outputs.google_play_url || 'Not available') }}',
              mrkdwn_in: ['text']
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}