default_platform(:android)

platform :android do
  desc "Build and upload to Google Play Internal Testing"
  lane :beta do |options|
    # 環境変数から環境を取得（dev/prod）
    environment = options[:env] || "prod"

    # ビルド番号を生成
    build_number = Time.now.to_i
    UI.message("🔢 Using build number: #{build_number}")

    # Flutter AABビルド（flavorとdart-define-from-fileの両方を使用）
    UI.message("📱 Building Android App Bundle for #{environment} environment...")
    sh("cd ../.. && flutter build appbundle --release --flavor #{environment} --dart-define-from-file=dart_defines/#{environment}.env --build-number=#{build_number}")

    # AABファイルの存在確認（flavorごとに異なるパス）
    aab_path = "../../build/app/outputs/bundle/#{environment}Release/app-#{environment}-release.aab"
    unless File.exist?(aab_path)
      UI.user_error!("❌ AAB file not found at: #{aab_path}")
    end

    UI.success("✅ AAB built successfully at: #{aab_path}")

    # Google Play Internal Testingへアップロード
    upload_to_play_store(
      track: "internal",
      aab: aab_path,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("🚀 Successfully uploaded to Google Play Internal Testing!")
  end

  desc "Build for Firebase App Distribution"
  lane :firebase do |options|
    # 環境変数から環境を取得（dev/prod）
    environment = options[:env] || "dev"

    # ビルド番号を生成
    build_number = Time.now.to_i
    UI.message("🔢 Using build number: #{build_number}")

    # APKビルド（flavorとdart-define-from-fileの両方を使用）
    UI.message("📱 Building Android APK for #{environment} environment...")
    sh("cd ../.. && flutter build apk --release --flavor #{environment} --dart-define-from-file=dart_defines/#{environment}.env --build-number=#{build_number}")

    # APKファイルの存在確認（CI/CDログから正しいパスを確認）
    apk_path = "../../build/app/outputs/flutter-apk/app-#{environment}-release.apk"
    unless File.exist?(apk_path)
      UI.user_error!("❌ APK file not found at: #{apk_path}")
    end

    UI.success("✅ APK built successfully at: #{apk_path}")

    # Firebase App Distributionへアップロード
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      # groups: "testers",  # testersグループが存在しない場合はコメントアウト
      testers_file: nil,  # テスターファイルも使用しない
      release_notes: "自動ビルド from #{environment} environment (Build: #{build_number})",
      android_artifact_type: "APK",
      android_artifact_path: apk_path
    )

    UI.success("🚀 Successfully uploaded to Firebase App Distribution!")
  end

  desc "Build and sign APK"
  lane :build do
    # バージョン番号を取得
    version_name = flutter_version()["version_name"]
    version_code = Time.now.to_i

    # Flutterビルド
    sh("flutter build apk --release --build-name=#{version_name} --build-number=#{version_code}")

    puts "✅ APK built successfully"
    puts "📍 Location: build/app/outputs/flutter-apk/app-release.apk"
  end

  desc "Promote from internal to production"
  lane :promote do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end

# Flutterのバージョン情報を取得するヘルパーメソッド
def flutter_version()
  pubspec = File.read("../pubspec.yaml")
  version_line = pubspec.lines.find { |line| line.start_with?("version:") }
  version = version_line.split(":").last.strip
  version_parts = version.split("+")

  {
    "version_name" => version_parts[0],
    "version_code" => version_parts[1] || "1"
  }
end