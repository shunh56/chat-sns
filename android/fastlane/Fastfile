default_platform(:android)

platform :android do
  desc "Build and upload to Google Play Internal Testing"
  lane :beta do |options|
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç’°å¢ƒã‚’å–å¾—ï¼ˆdev/prodï¼‰
    environment = options[:env] || "prod"

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’ç”Ÿæˆ
    build_number = Time.now.to_i
    UI.message("ğŸ”¢ Using build number: #{build_number}")

    # Flutter AABãƒ“ãƒ«ãƒ‰ï¼ˆflavorã¨dart-define-from-fileã®ä¸¡æ–¹ã‚’ä½¿ç”¨ï¼‰
    UI.message("ğŸ“± Building Android App Bundle for #{environment} environment...")
    sh("cd ../.. && flutter build appbundle --release --flavor #{environment} --dart-define-from-file=dart_defines/#{environment}.json --build-number=#{build_number}")

    # AABãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆflavorã”ã¨ã«ç•°ãªã‚‹ãƒ‘ã‚¹ï¼‰
    aab_path = "../../build/app/outputs/bundle/#{environment}Release/app-#{environment}-release.aab"
    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB file not found at: #{aab_path}")
    end

    # Google Playç”¨ã«çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    absolute_aab_path = File.expand_path(aab_path)
    UI.success("âœ… AAB built successfully at: #{aab_path}")
    UI.message("ğŸ“ Absolute path for Google Play: #{absolute_aab_path}")

    # Google Play Internal Testingã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_play_store(
      track: "internal",
      aab: absolute_aab_path,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("ğŸš€ Successfully uploaded to Google Play Internal Testing!")
  end

  desc "Build for Firebase App Distribution"
  lane :firebase do |options|
    # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç’°å¢ƒã‚’å–å¾—ï¼ˆdev/prodï¼‰
    environment = options[:env] || "dev"

    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’ç”Ÿæˆ
    build_number = Time.now.to_i
    UI.message("ğŸ”¢ Using build number: #{build_number}")

    # APKãƒ“ãƒ«ãƒ‰ï¼ˆflavorã¨dart-define-from-fileã®ä¸¡æ–¹ã‚’ä½¿ç”¨ï¼‰
    UI.message("ğŸ“± Building Android APK for #{environment} environment...")
    sh("cd ../.. && flutter build apk --release --flavor #{environment} --dart-define-from-file=dart_defines/#{environment}.json --build-number=#{build_number}")

    # APKãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆCI/CDãƒ­ã‚°ã‹ã‚‰æ­£ã—ã„ãƒ‘ã‚¹ã‚’ç¢ºèªï¼‰
    apk_path = "../../build/app/outputs/flutter-apk/app-#{environment}-release.apk"

    UI.message("ğŸ” Checking APK file at: #{apk_path}")
    UI.message("ğŸ“‚ Current working directory: #{Dir.pwd}")

    unless File.exist?(apk_path)
      # APKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢
      UI.message("ğŸ” APK not found at expected path, searching build directory...")

      possible_paths = [
        "../../build/app/outputs/flutter-apk/app-#{environment}-release.apk",
        "../build/app/outputs/flutter-apk/app-#{environment}-release.apk",
        "build/app/outputs/flutter-apk/app-#{environment}-release.apk",
        "../../build/app/outputs/apk/#{environment}/release/app-#{environment}-release.apk"
      ]

      found_path = nil
      possible_paths.each do |path|
        if File.exist?(path)
          found_path = path
          UI.message("âœ… Found APK at: #{path}")
          break
        else
          UI.message("âŒ Not found at: #{path}")
        end
      end

      if found_path
        apk_path = found_path
      else
        # æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ã€ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º
        UI.message("ğŸ“ Listing build directory contents:")
        Dir.glob("../../build/app/outputs/**/*.apk").each do |file|
          UI.message("   ğŸ“„ #{file}")
        end
        UI.user_error!("âŒ APK file not found at any expected location")
      end
    end

    # Firebase App Distributionç”¨ã«çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    absolute_apk_path = File.expand_path(apk_path)
    UI.success("âœ… APK built successfully at: #{apk_path}")
    UI.message("ğŸ“ Absolute path for Firebase: #{absolute_apk_path}")
    UI.message("ğŸ—‚ï¸ File exists check (absolute): #{File.exist?(absolute_apk_path)}")

    # Firebase App Distributionã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    firebase_params = {
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      release_notes: "è‡ªå‹•ãƒ“ãƒ«ãƒ‰ from #{environment} environment (Build: #{build_number})",
      android_artifact_type: "APK",
      android_artifact_path: absolute_apk_path
    }

    # ãƒ†ã‚¹ã‚¿ãƒ¼è¨­å®š: ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ã‚¹ã‚¿ãƒ¼ã‚’ä½¿ç”¨
    if ENV["FIREBASE_TESTERS"] && !ENV["FIREBASE_TESTERS"].empty?
      UI.message("ğŸ“§ Adding testers from environment variable: #{ENV["FIREBASE_TESTERS"]}")
      firebase_params[:testers] = ENV["FIREBASE_TESTERS"]
    elsif ENV["FIREBASE_TESTER_GROUPS"] && !ENV["FIREBASE_TESTER_GROUPS"].empty?
      UI.message("ğŸ‘¥ Adding tester groups: #{ENV["FIREBASE_TESTER_GROUPS"]}")
      firebase_params[:groups] = ENV["FIREBASE_TESTER_GROUPS"]
    else
      UI.message("â„¹ï¸ No specific testers configured, using default distribution settings")
    end

    result = firebase_app_distribution(firebase_params)

    # Firebaseçµæœã‚’ãƒ‡ãƒãƒƒã‚°
    UI.message("ğŸ” Firebase App Distribution result: #{result.inspect}")
    UI.message("ğŸ” Available keys: #{result.keys.inspect}") if result.respond_to?(:keys)

    # Firebase URLã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¦GitHub Actionsã§åˆ©ç”¨
    firebase_url = nil

    # è¤‡æ•°ã®å¯èƒ½æ€§ã‚’è©¦ã™
    if result.respond_to?(:[])
      firebase_url = result[:testingUri] || result[:testing_uri] || result[:firebaseConsoleUri] || result[:console_uri]
    end

    # Fastlaneå†…éƒ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚‚è©¦ã™
    if !firebase_url && lane_context[SharedValues::FIREBASE_APP_DISTRO_RELEASE]
      release_info = lane_context[SharedValues::FIREBASE_APP_DISTRO_RELEASE]
      UI.message("ğŸ” Release info from lane_context: #{release_info.inspect}")
      firebase_url = release_info[:testingUri] || release_info[:testing_uri] || release_info[:firebaseConsoleUri] || release_info[:console_uri] if release_info.respond_to?(:[])
    end

    # æœ€çµ‚çš„ã«ã¯ãƒ­ã‚°ã‹ã‚‰URLã‚’æ§‹ç¯‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦åŸºæœ¬URLã‚’ä½¿ç”¨ï¼‰
    if !firebase_url && ENV["FIREBASE_APP_ID_ANDROID"]
      # æˆåŠŸã—ãŸCI/CDãƒ­ã‚°ã‹ã‚‰å®Ÿéš›ã®URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
      firebase_url = "https://appdistribution.firebase.google.com/testerapps/#{ENV["FIREBASE_APP_ID_ANDROID"]}/releases"
    end

    if firebase_url
      File.write("../../firebase_android_url.txt", firebase_url)
      UI.message("ğŸ”— Firebase URL saved: #{firebase_url}")
      UI.message("ğŸ“ File saved at: #{File.expand_path('../../firebase_android_url.txt')}")
    else
      UI.error("âŒ Could not determine Firebase URL")
      File.write("../../firebase_android_url.txt", "Firebase URL not available")
    end

    UI.success("ğŸš€ Successfully uploaded to Firebase App Distribution!")
  end

  desc "Build and sign APK"
  lane :build do
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
    version_name = flutter_version()["version_name"]
    version_code = Time.now.to_i

    # Flutterãƒ“ãƒ«ãƒ‰
    sh("flutter build apk --release --build-name=#{version_name} --build-number=#{version_code}")

    puts "âœ… APK built successfully"
    puts "ğŸ“ Location: build/app/outputs/flutter-apk/app-release.apk"
  end

  desc "Promote from internal to production"
  lane :promote do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end

# Flutterã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
def flutter_version()
  pubspec = File.read("../pubspec.yaml")
  version_line = pubspec.lines.find { |line| line.start_with?("version:") }
  version = version_line.split(":").last.strip
  version_parts = version.split("+")

  {
    "version_name" => version_parts[0],
    "version_code" => version_parts[1] || "1"
  }
end