# ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ æŠ€è¡“ä»•æ§˜æ›¸

## ç›®æ¬¡
1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ãƒ‡ãƒ¼ã‚¿æ§‹é€ ](#ãƒ‡ãƒ¼ã‚¿æ§‹é€ )
4. [æ©Ÿèƒ½ä»•æ§˜](#æ©Ÿèƒ½ä»•æ§˜)
5. [APIä»•æ§˜](#apiä»•æ§˜)
6. [UI/UXä»•æ§˜](#uiuxä»•æ§˜)
7. [é€šçŸ¥æ©Ÿèƒ½](#é€šçŸ¥æ©Ÿèƒ½)
8. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
9. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
10. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
11. [å°†æ¥ã®æ‹¡å¼µ](#å°†æ¥ã®æ‹¡å¼µ)

---

## æ¦‚è¦

### æ©Ÿèƒ½ã®ç›®çš„
ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã§ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚’é€ä¿¡ã—ã€æ‰¿èªã‚’å¾—ã¦ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã§ãã‚‹æ©Ÿèƒ½ã€‚ã‚¹ãƒ‘ãƒ ã‚„æœ›ã¾ãªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é˜²ãã€å®‰å…¨ã§å¿«é©ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã‚’æä¾›ã™ã‚‹ã€‚

### ä¸»è¦æ©Ÿèƒ½
- ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»˜ãå¯èƒ½ï¼‰
- å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¢ºèªãƒ»æ‰¿èªãƒ»å´ä¸‹
- é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¢ºèªãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚ãƒ»æ‰¿èªæ™‚ã®ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰
- æ‰¿èªå¾Œã®è‡ªå‹•ãƒãƒ£ãƒƒãƒˆç”»é¢é·ç§»
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆFirestoreã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰

### ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿è­·**: æœ›ã¾ãªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿è­·
- **ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå‘ä¸Š**: æ‰¿èªãƒ™ãƒ¼ã‚¹ã®å®‰å¿ƒã§ãã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- **ã‚¹ãƒ‘ãƒ é˜²æ­¢**: ç„¡å·®åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’æŠ‘åˆ¶
- **UXæ”¹å–„**: ä¸å¯§ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¿ƒé€²

---

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é©ç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Screen          â”‚â†’ â”‚  Provider    â”‚â†’ â”‚  Helper       â”‚ â”‚
â”‚  â”‚  (UI/Widget)     â”‚  â”‚  (State)     â”‚  â”‚  (Utility)    â”‚ â”‚
â”‚  â”‚  - List Screen   â”‚  â”‚  - Notifier  â”‚  â”‚  - Helper     â”‚ â”‚
â”‚  â”‚  - Dialog        â”‚  â”‚              â”‚  â”‚               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Use Case        â”‚â†’ â”‚ IRepository  â”‚  â”‚  Entity       â”‚ â”‚
â”‚  â”‚  (Logic)         â”‚  â”‚ (Interface)  â”‚  â”‚  (Model)      â”‚ â”‚
â”‚  â”‚  - SendRequest   â”‚  â”‚              â”‚  â”‚  - Request    â”‚ â”‚
â”‚  â”‚  - AcceptRequest â”‚  â”‚              â”‚  â”‚  - Status     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  Repository      â”‚â†’ â”‚  Datasource  â”‚â†’ Firebase Firestore â”‚
â”‚  â”‚  Impl            â”‚  â”‚  (Firebase)  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Push         â”‚
                    â”‚  Notification â”‚
                    â”‚  (FCM)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®è²¬å‹™

#### Presentation Layer
- **Screen**: UIè¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã€ç”»é¢é·ç§»
- **Provider (Notifier)**: çŠ¶æ…‹ç®¡ç†ï¼ˆRiverpodï¼‰ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
- **Helper**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆçµ±åˆ

#### Domain Layer
- **UseCase**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ã€é€šçŸ¥é€£æºã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
- **IRepository**: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- **Entity**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

#### Data Layer
- **Repository Impl**: IRepositoryã®å…·ä½“çš„å®Ÿè£…ã€ã‚¨ãƒ©ãƒ¼å¤‰æ›
- **Datasource**: Firebase Firestoreã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã€CRUDæ“ä½œ

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### Entityæ§‹æˆ

```
domain/entity/
  â””â”€â”€ chat_request.dart           # ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆEntity
```

### Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

```
/chat_requests/{requestId}
  â”œâ”€â”€ id: string                  # ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆUUID v4ï¼‰
  â”œâ”€â”€ fromUserId: string          # é€ä¿¡è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  â”œâ”€â”€ toUserId: string            # å—ä¿¡è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  â”œâ”€â”€ createdAt: timestamp        # ä½œæˆæ—¥æ™‚
  â”œâ”€â”€ status: string              # "pending" | "accepted" | "rejected"
  â””â”€â”€ message: string | null      # æ·»ä»˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ã€æœ€å¤§200æ–‡å­—ï¼‰
```

**è¨­è¨ˆã®ç‰¹å¾´:**
- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒ©ãƒƒãƒˆãªæ§‹é€ 
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«ã‚ˆã‚‹æ™‚ç³»åˆ—ç®¡ç†
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»»æ„é …ç›®

### Entityãƒ¢ãƒ‡ãƒ«

#### ChatRequest Entity

```dart
class ChatRequest {
  final String id;               // ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆUUIDv4ï¼‰
  final String fromUserId;       // é€ä¿¡è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  final String toUserId;         // å—ä¿¡è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  final Timestamp createdAt;     // ä½œæˆæ—¥æ™‚
  final ChatRequestStatus status; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  final String? message;         // æ·»ä»˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ã€æœ€å¤§200æ–‡å­—ï¼‰

  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
  bool get isPending => status == ChatRequestStatus.pending;
  bool get isAccepted => status == ChatRequestStatus.accepted;
  bool get isRejected => status == ChatRequestStatus.rejected;

  // Factory
  factory ChatRequest.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
  ChatRequest copyWith({...});
}
```

#### ChatRequestStatus Enum

```dart
enum ChatRequestStatus {
  pending('pending'),     // æœªæ‰¿èªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  accepted('accepted'),   // æ‰¿èªæ¸ˆã¿
  rejected('rejected');   // å´ä¸‹æ¸ˆã¿

  const ChatRequestStatus(this.value);
  final String value;

  static ChatRequestStatus fromString(String value);
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»:**
```
pending â†’ accepted  ï¼ˆæ‰¿èªï¼‰
pending â†’ rejected  ï¼ˆå´ä¸‹ï¼‰
pending â†’ [å‰Šé™¤]    ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
```

---

## æ©Ÿèƒ½ä»•æ§˜

### 1. ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡

#### ãƒˆãƒªã‚¬ãƒ¼
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ï¼ˆè¤‡æ•°ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```
1. SendChatRequestHelper.startChatOrRequest() ã‚’å‘¼ã³å‡ºã—
   â†“
2. æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®å­˜åœ¨ç¢ºèª
   - å­˜åœ¨ã™ã‚‹ â†’ ç›´æ¥ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸é·ç§»ï¼ˆå‡¦ç†çµ‚äº†ï¼‰
   â†“
3. æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å­˜åœ¨ç¢ºèª
   - å­˜åœ¨ã™ã‚‹ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆå‡¦ç†çµ‚äº†ï¼‰
   â†“
4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ï¼ˆä»»æ„ã€æœ€å¤§200æ–‡å­—ï¼‰
   â†“
5. ChatRequestUsecase.sendRequest() ã‚’å®Ÿè¡Œ
   â†“
6. Repository.sendRequest() ã§Firestoreã«ä¿å­˜
   - requestId: UUIDv4è‡ªå‹•ç”Ÿæˆ
   - fromUserId: é€ä¿¡è€…ID
   - toUserId: å—ä¿¡è€…ID
   - status: "pending"
   - message: å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã¾ãŸã¯ nullï¼‰
   - createdAt: ç¾åœ¨æ™‚åˆ»
   â†“
7. PushNotificationUsecase.sendChatRequest() ã§é€šçŸ¥é€ä¿¡
   - UserAccountã‚’å–å¾—
   - ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼ˆactiveDevicesï¼‰
   - ã‚¿ã‚¤ãƒˆãƒ«: é€ä¿¡è€…å
   - æœ¬æ–‡: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ or "ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã¾ã—ãŸã€‚"
   â†“
8. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
```

#### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª
- ç›¸æ‰‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ç¢ºèª
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡å­—æ•°åˆ¶é™ï¼ˆ200æ–‡å­—ï¼‰
- é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯

#### ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `user_profile_page.dart`
   - ãƒˆãƒªã‚¬ãƒ¼: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³

2. **ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ç”»é¢**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `user_request_widget.dart`
   - ãƒˆãƒªã‚¬ãƒ¼: ãƒãƒ£ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ï¼ˆUserRequestWidgetå†…ï¼‰

3. **ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”»é¢**ï¼ˆå®Ÿè£…çŠ¶æ³è¦ç¢ºèªï¼‰
   - ãƒ•ã‚¡ã‚¤ãƒ«: `timeline_square_sections.dart`

#### Firestoreãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
```dart
Future<void> sendRequest({
  required String toUserId,
  String? message,
}) async {
  final requestId = const Uuid().v4();
  final request = ChatRequest(
    id: requestId,
    fromUserId: _auth.currentUser!.uid,
    toUserId: toUserId,
    createdAt: Timestamp.now(),
    status: ChatRequestStatus.pending,
    message: message,
  );

  await _firestore
      .collection('chat_requests')
      .doc(requestId)
      .set(request.toJson());
}
```

---

### 2. å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§å–å¾—

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- `chat_requests`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- ãƒ•ã‚£ãƒ«ã‚¿: `toUserId == myUserId` AND `status == "pending"`

#### å–å¾—æ–¹æ³•ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰
```dart
Stream<QuerySnapshot<Map<String, dynamic>>> streamReceivedRequests() {
  return _firestore
      .collection('chat_requests')
      .where('toUserId', isEqualTo: _auth.currentUser!.uid)
      .where('status', isEqualTo: 'pending')
      .orderBy('createdAt', descending: true)
      .snapshots();
}
```

#### ã‚½ãƒ¼ãƒˆé †
- `createdAt` é™é †ï¼ˆæœ€æ–°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå…ˆé ­ï¼‰

#### è¡¨ç¤ºå†…å®¹
- é€ä¿¡è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆUserWidgetçµŒç”±ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å
  - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹
- æ·»ä»˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
- é€ä¿¡æ™‚åˆ»ï¼ˆç›¸å¯¾æ™‚é–“è¡¨ç¤º: "1åˆ†å‰"ï¼‰
- æ‰¿èªãƒœã‚¿ãƒ³
- å´ä¸‹ãƒœã‚¿ãƒ³

---

### 3. é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§å–å¾—

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- `chat_requests`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
- ãƒ•ã‚£ãƒ«ã‚¿: `fromUserId == myUserId` AND `status == "pending"`

#### å–å¾—æ–¹æ³•ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰
```dart
Stream<QuerySnapshot<Map<String, dynamic>>> streamSentRequests() {
  return _firestore
      .collection('chat_requests')
      .where('fromUserId', isEqualTo: _auth.currentUser!.uid)
      .where('status', isEqualTo: 'pending')
      .orderBy('createdAt', descending: true)
      .snapshots();
}
```

#### è¡¨ç¤ºå†…å®¹
- é€ä¿¡å…ˆã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆUserWidgetçµŒç”±ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- "é€ä¿¡æ¸ˆã¿" ãƒãƒƒã‚¸
- æ·»ä»˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
- é€ä¿¡æ™‚åˆ»ï¼ˆç›¸å¯¾æ™‚é–“è¡¨ç¤ºï¼‰
- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³

---

### 4. ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èª

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```
1. ReceivedRequestsNotifier.acceptRequest() ã‚’å‘¼ã³å‡ºã—
   â†“
2. ChatRequestUsecase.acceptRequest() ã‚’å®Ÿè¡Œ
   â†“
3. Repository.acceptRequest() ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
   - status: "pending" â†’ "accepted"
   â†“
4. DirectMessageOverviewUsecase.joinChat() ã§DMãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
   - /direct_messages/{roomId}
   - roomId: DMKeyConverter.getKey(myUserId, otherUserId)
   - users: {myUserId: true, otherUserId: true}
   â†“
5. PushNotificationUsecase.sendChatRequestAccepted() ã§é€šçŸ¥é€ä¿¡
   - é€ä¿¡è€…ã®UserAccountã‚’å–å¾—
   - ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
   - ã‚¿ã‚¤ãƒˆãƒ«: æ‰¿èªè€…å
   - æœ¬æ–‡: "ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚"
   â†“
6. ãƒãƒ£ãƒƒãƒˆç”»é¢ã«è‡ªå‹•é·ç§»ï¼ˆNavigator.pushReplacementï¼‰
```

#### Firestoreæ›´æ–°å‡¦ç†
```dart
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
Future<void> acceptRequest(String requestId) async {
  await _firestore
      .collection('chat_requests')
      .doc(requestId)
      .update({
    'status': ChatRequestStatus.accepted.value,
  });
}

// DMãƒ«ãƒ¼ãƒ ä½œæˆ
Future<void> joinChat(String otherUserId) async {
  String roomId = DMKeyConverter.getKey(_auth.currentUser!.uid, otherUserId);
  await _firestore
      .collection("direct_messages")
      .doc(roomId)
      .set({
    "users.${_auth.currentUser!.uid}": true,
    "users.$otherUserId": true,
  }, SetOptions(merge: true));
}
```

#### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å­˜åœ¨ç¢ºèª
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆpending ã®ã¿æ‰¿èªå¯èƒ½ï¼‰
- é€ä¿¡è€…ãƒ»å—ä¿¡è€…ã®æ•´åˆæ€§ç¢ºèª

---

### 5. ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```
1. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
   - ã‚¿ã‚¤ãƒˆãƒ«: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å´ä¸‹"
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ"
   â†“
2. ç¢ºèªå¾Œã€ReceivedRequestsNotifier.rejectRequest() ã‚’å‘¼ã³å‡ºã—
   â†“
3. Repository.rejectRequest() ã§Firestoreã‹ã‚‰å‰Šé™¤
   â†“
4. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
   â†“
5. ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªå‹•å‰Šé™¤ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ æ›´æ–°ã«ã‚ˆã‚Šï¼‰
```

**é‡è¦:** å´ä¸‹æ™‚ã¯é€ä¿¡è€…ã«é€šçŸ¥ã‚’é€ã‚‰ãªã„ï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼‰

#### Firestoreå‰Šé™¤å‡¦ç†
```dart
Future<void> rejectRequest(String requestId) async {
  await _firestore
      .collection('chat_requests')
      .doc(requestId)
      .delete();
}
```

---

### 6. ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼
```
1. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
   - ã‚¿ã‚¤ãƒˆãƒ«: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ"
   â†“
2. ç¢ºèªå¾Œã€SentRequestsNotifier.cancelRequest() ã‚’å‘¼ã³å‡ºã—
   â†“
3. Repository.cancelRequest() ã§Firestoreã‹ã‚‰å‰Šé™¤
   â†“
4. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
   â†“
5. ä¸¡è€…ã®ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªå‹•å‰Šé™¤ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ æ›´æ–°ã«ã‚ˆã‚Šï¼‰
```

#### Firestoreå‰Šé™¤å‡¦ç†
```dart
Future<void> cancelRequest(String requestId) async {
  await _firestore
      .collection('chat_requests')
      .doc(requestId)
      .delete();
}
```

---

### 7. æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ãƒã‚§ãƒƒã‚¯

#### ãƒã‚§ãƒƒã‚¯å†…å®¹
1. **æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®ç¢ºèª**
   - DMOverviewãƒªã‚¹ãƒˆã‚’ç¢ºèª
   - å­˜åœ¨ã™ã‚‹ â†’ ç›´æ¥ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸é·ç§»

2. **æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¢ºèª**
   - è‡ªåˆ†ãŒé€ã£ãŸpendingãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   - ç›¸æ‰‹ã‹ã‚‰å—ã‘å–ã£ãŸpendingãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   - å­˜åœ¨ã™ã‚‹ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

#### ã‚¯ã‚¨ãƒªå‡¦ç†
```dart
Future<ChatRequest?> checkExistingRequest(String otherUserId) async {
  // è‡ªåˆ†ãŒé€ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  final sentQuery = await _firestore
      .collection('chat_requests')
      .where('fromUserId', isEqualTo: _auth.currentUser!.uid)
      .where('toUserId', isEqualTo: otherUserId)
      .where('status', isEqualTo: 'pending')
      .limit(1)
      .get();

  if (sentQuery.docs.isNotEmpty) {
    return ChatRequest.fromJson(sentQuery.docs.first.data());
  }

  // ç›¸æ‰‹ã‹ã‚‰å—ã‘å–ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  final receivedQuery = await _firestore
      .collection('chat_requests')
      .where('fromUserId', isEqualTo: otherUserId)
      .where('toUserId', isEqualTo: _auth.currentUser!.uid)
      .where('status', isEqualTo: 'pending')
      .limit(1)
      .get();

  if (receivedQuery.docs.isNotEmpty) {
    return ChatRequest.fromJson(receivedQuery.docs.first.data());
  }

  return null;
}
```

---

## APIä»•æ§˜

### Repository Interfaceï¼ˆIChatRequestRepositoryï¼‰

| ãƒ¡ã‚½ãƒƒãƒ‰ | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|---------|--------|------|
| `streamReceivedRequests()` | `Stream<List<ChatRequest>>` | å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰ |
| `streamSentRequests()` | `Stream<List<ChatRequest>>` | é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰ |
| `checkExistingRequest(String otherUserId)` | `Future<ChatRequest?>` | æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¢ºèª |
| `sendRequest({required String toUserId, String? message})` | `Future<void>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ |
| `acceptRequest(String requestId)` | `Future<void>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èª |
| `rejectRequest(String requestId)` | `Future<void>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å´ä¸‹ |
| `cancelRequest(String requestId)` | `Future<void>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| `getRequest(String requestId)` | `Future<ChatRequest?>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾— |

---

### UseCases

#### ChatRequestUsecase
```dart
class ChatRequestUsecase {
  final Ref _ref;
  final ChatRequestRepository _repository;
  final DirectMessageOverviewUsecase _dmOverviewUsecase;
  final PushNotificationUsecase _pushNotificationUsecase;

  // å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ 
  Stream<List<ChatRequest>> streamReceivedRequests() {
    return _repository.streamReceivedRequests();
  }

  // é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ 
  Stream<List<ChatRequest>> streamSentRequests() {
    return _repository.streamSentRequests();
  }

  // æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
  Future<ChatRequest?> checkExistingRequest(String otherUserId) {
    return _repository.checkExistingRequest(otherUserId);
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼ˆé€šçŸ¥çµ±åˆï¼‰
  Future<void> sendRequest({
    required String toUserId,
    String? message,
  }) async {
    // æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
    final existingRequest = await checkExistingRequest(toUserId);
    if (existingRequest != null) {
      throw Exception('æ—¢ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå­˜åœ¨ã—ã¾ã™');
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
    await _repository.sendRequest(
      toUserId: toUserId,
      message: message,
    );

    // é€šçŸ¥é€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã™ï¼‰
    try {
      final toUser = await _getUserAccount(toUserId);
      if (toUser != null) {
        await _pushNotificationUsecase.sendChatRequest(toUser, message);
      }
    } catch (e) {
      print('ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—: $e');
    }
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªï¼ˆé€šçŸ¥çµ±åˆï¼‰
  Future<void> acceptRequest(String requestId) async {
    final request = await _repository.getRequest(requestId);
    if (request == null) {
      throw Exception('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èª
    await _repository.acceptRequest(requestId);

    // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã«å‚åŠ 
    await _dmOverviewUsecase.joinChat(request.fromUserId);

    // é€šçŸ¥é€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã™ï¼‰
    try {
      final fromUser = await _getUserAccount(request.fromUserId);
      if (fromUser != null) {
        await _pushNotificationUsecase.sendChatRequestAccepted(fromUser);
      }
    } catch (e) {
      print('ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—: $e');
    }
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹
  Future<void> rejectRequest(String requestId) {
    return _repository.rejectRequest(requestId);
  }

  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
  Future<void> cancelRequest(String requestId) {
    return _repository.cancelRequest(requestId);
  }

  // UserAccountå–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼
  Future<UserAccount?> _getUserAccount(String userId) async {
    // AllUsersNotifierã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã„å ´åˆã¯å–å¾—ã‚’è©¦ã¿ã‚‹
  }
}
```

---

### Providersï¼ˆState Managementï¼‰

#### receivedRequestsNotifierProvider
```dart
@riverpod
class ReceivedRequestsNotifier extends _$ReceivedRequestsNotifier {
  @override
  Stream<List<ChatRequest>> build() {
    return ref.watch(chatRequestUsecaseProvider).streamReceivedRequests();
  }

  Future<void> acceptRequest(ChatRequest request) async {
    await ref.read(chatRequestUsecaseProvider).acceptRequest(request.id);
  }

  Future<void> rejectRequest(ChatRequest request) async {
    await ref.read(chatRequestUsecaseProvider).rejectRequest(request.id);
  }
}
```

#### sentRequestsNotifierProvider
```dart
@riverpod
class SentRequestsNotifier extends _$SentRequestsNotifier {
  @override
  Stream<List<ChatRequest>> build() {
    return ref.watch(chatRequestUsecaseProvider).streamSentRequests();
  }

  Future<void> cancelRequest(ChatRequest request) async {
    await ref.read(chatRequestUsecaseProvider).cancelRequest(request.id);
  }
}
```

#### pendingRequestCountProviderï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```dart
@riverpod
Future<int> pendingRequestCount(PendingRequestCountRef ref) async {
  final requests = await ref.watch(receivedRequestsNotifierProvider.future);
  return requests.length;
}
```

---

## UI/UXä»•æ§˜

### ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ç”»é¢ï¼ˆChatRequestListScreenï¼‰

#### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    AppBar: "ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TabBar                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å—ä¿¡   â”‚    é€ä¿¡      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TabBarView                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  UserCard            â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Icon & Name      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Message (opt)    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Timestamp        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Actions          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     [å´ä¸‹] [æ‰¿èª]    â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  UserCard            â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ã‚¿ãƒ–æ§‹æˆ
1. **å—ä¿¡ã‚¿ãƒ–**: è‡ªåˆ†å®›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§
2. **é€ä¿¡ã‚¿ãƒ–**: è‡ªåˆ†ãŒé€ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§

#### ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆå—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

**ãƒ‡ã‚¶ã‚¤ãƒ³:**
- èƒŒæ™¯è‰²: `ThemeColor.accent`
- è§’ä¸¸: 16px
- ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°: 18px
- ã‚·ãƒ£ãƒ‰ã‚¦: è»½ã„ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦

**å†…å®¹:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ [ã‚¢ã‚¤ã‚³ãƒ³]  ãƒ¦ãƒ¼ã‚¶ãƒ¼å   1åˆ†å‰  â”‚
â”‚                âœ“ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³        â”‚
â”‚                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ "ã¯ã˜ã‚ã¾ã—ã¦ï¼ãŠè©±ã—ã—ãŸã„    â”‚ â”‚
â”‚ â”‚  ã§ã™"                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚
â”‚ [    å´ä¸‹    ]  [    æ‰¿èª    ]    â”‚
â”‚  (ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³)  (ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰¿èªãƒœã‚¿ãƒ³:**
- ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: `ThemeColor.highlight` â†’ `Colors.cyan`
- ã‚¢ã‚¤ã‚³ãƒ³: `Icons.check_circle`
- ãƒ†ã‚­ã‚¹ãƒˆ: "æ‰¿èª"

**å´ä¸‹ãƒœã‚¿ãƒ³:**
- ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³: `ThemeColor.stroke`
- ã‚¢ã‚¤ã‚³ãƒ³: `Icons.close`
- ãƒ†ã‚­ã‚¹ãƒˆ: "å´ä¸‹"

#### ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆé€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

**å†…å®¹:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ [ã‚¢ã‚¤ã‚³ãƒ³]  ãƒ¦ãƒ¼ã‚¶ãƒ¼å   1åˆ†å‰  â”‚
â”‚                [é€ä¿¡æ¸ˆã¿]          â”‚
â”‚                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ "ã¯ã˜ã‚ã¾ã—ã¦ï¼ãŠè©±ã—ã—ãŸã„    â”‚ â”‚
â”‚ â”‚  ã§ã™"                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚
â”‚ [   ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«   ]    â”‚
â”‚        (èµ¤è‰²ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é€ä¿¡æ¸ˆã¿ãƒãƒƒã‚¸:**
- ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ï¼ˆè–„ã‚ï¼‰
- ã‚¢ã‚¤ã‚³ãƒ³: `Icons.send`ï¼ˆã‚µã‚¤ã‚º12ï¼‰
- ãƒ†ã‚­ã‚¹ãƒˆ: "é€ä¿¡æ¸ˆã¿"

**ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³:**
- ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³: `Colors.red.shade400`
- ã‚¢ã‚¤ã‚³ãƒ³: `Icons.cancel_outlined`
- ãƒ†ã‚­ã‚¹ãƒˆ: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«"

#### çŠ¶æ…‹è¡¨ç¤º

##### ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
```dart
Center(child: CircularProgressIndicator())
```

##### ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
```dart
Center(
  child: Text(
    'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    style: TextStyle(color: ThemeColor.subText),
  ),
)
```

##### ç©ºçŠ¶æ…‹ï¼ˆå—ä¿¡ã‚¿ãƒ–ï¼‰
```dart
Center(
  child: Column(
    children: [
      Icon(Icons.inbox_outlined, size: 64),
      Gap(16),
      Text("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"),
    ],
  ),
)
```

##### ç©ºçŠ¶æ…‹ï¼ˆé€ä¿¡ã‚¿ãƒ–ï¼‰
```dart
Center(
  child: Column(
    children: [
      Icon(Icons.send_outlined, size: 64),
      Gap(16),
      Text("é€ä¿¡ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"),
    ],
  ),
)
```

---

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚°

#### ãƒ‡ã‚¶ã‚¤ãƒ³
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ              â”‚
â”‚                                    â”‚
â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ·»ãˆã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’      â”‚
â”‚ é€ä¿¡ã§ãã¾ã™                       â”‚
â”‚                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä¾‹: ã¯ã˜ã‚ã¾ã—ã¦ï¼            â”‚ â”‚
â”‚ â”‚ ãŠè©±ã—ã—ãŸã„ã§ã™              â”‚ â”‚
â”‚ â”‚                               â”‚ â”‚
â”‚ â”‚                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ 0/200æ–‡å­—                          â”‚
â”‚                                    â”‚
â”‚ [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]     [é€ä¿¡]            â”‚
â”‚  (ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³)  (ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä»•æ§˜
- èƒŒæ™¯è‰²: `ThemeColor.accent`
- è§’ä¸¸: 20px
- ã‚·ãƒ£ãƒ‰ã‚¦: å¼·ã‚ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦
- ã‚¢ã‚¤ã‚³ãƒ³: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®`Icons.chat_bubble_outline`
- ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:
  - æœ€å¤§è¡Œæ•°: 4è¡Œ
  - æœ€å¤§æ–‡å­—æ•°: 200æ–‡å­—
  - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼: "ä¾‹: ã¯ã˜ã‚ã¾ã—ã¦ï¼ãŠè©±ã—ã—ãŸã„ã§ã™"
- é€ä¿¡ãƒœã‚¿ãƒ³: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ + `Icons.send`

#### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
- ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ï¼ˆnullã‚’è¿”ã™ï¼‰
- é€ä¿¡: å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™ï¼ˆç©ºæ–‡å­—åˆ—å¯ï¼‰

---

### ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ï¼ˆSendChatRequestHelperï¼‰

#### å½¹å‰²
è¤‡æ•°ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰çµ±ä¸€çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‡¦ç†ã‚’å®Ÿè¡Œ

#### ãƒ¡ã‚½ãƒƒãƒ‰
```dart
static Future<void> startChatOrRequest({
  required BuildContext context,
  required WidgetRef ref,
  required String targetUserId,
}) async {
  // 1. æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯
  // 2. æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
  // 3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
  // 4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‡¦ç†
}
```

#### ä½¿ç”¨ä¾‹
```dart
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢
IconButton(
  icon: Icon(Icons.chat_bubble_outline),
  onPressed: () {
    SendChatRequestHelper.startChatOrRequest(
      context: context,
      ref: ref,
      targetUserId: user.userId,
    );
  },
)

// ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ç”»é¢
IconButton(
  icon: Icon(Icons.chat_bubble_outline),
  onPressed: () {
    SendChatRequestHelper.startChatOrRequest(
      context: context,
      ref: ref,
      targetUserId: user.userId,
    );
  },
)
```

---

## é€šçŸ¥æ©Ÿèƒ½

### ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®çµ±åˆ

#### PushNotificationTypeæ‹¡å¼µ
```dart
enum PushNotificationType {
  dm,
  call,
  like,
  comment,
  follow,
  friendRequest,
  chatRequest,           // â˜… æ–°è¦è¿½åŠ 
  chatRequestAccepted,   // â˜… æ–°è¦è¿½åŠ 
  defaultType,
}
```

### ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é€šçŸ¥

#### ä»•æ§˜
```dart
Future<void> sendChatRequest(UserAccount user, String? message) async {
  final sender = _generateSender();
  final receivers = _generateReceivers(user); // ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ

  if (receivers.isEmpty) return;

  await _sendPushNotification(
    type: PushNotificationType.chatRequest,
    sender: sender,
    recipients: receivers,
    content: PushNotificationContent(
      title: sender.name,
      body: message?.isNotEmpty == true
          ? message!
          : "ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã¾ã—ãŸã€‚",
    ),
    payload: PushNotificationPayload(
      text: message,
    ),
  );
}
```

#### é€šçŸ¥è¡¨ç¤ºä¾‹
```
é€šçŸ¥ãƒãƒ¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ å±±ç”°å¤ªéƒ                     â”‚
â”‚ ã¯ã˜ã‚ã¾ã—ã¦ï¼ãŠè©±ã—ã—ãŸã„ã§ã™  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
- UserAccount.activeDevices ã‹ã‚‰å…¨ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
- FCMãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ãªãƒ‡ãƒã‚¤ã‚¹ã«é€šçŸ¥é€ä¿¡
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: activeDevicesãŒç©ºã®å ´åˆã¯ fcmToken ã‚’ä½¿ç”¨

---

### ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªé€šçŸ¥

#### ä»•æ§˜
```dart
Future<void> sendChatRequestAccepted(UserAccount user) async {
  final sender = _generateSender();
  final receivers = _generateReceivers(user); // ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ

  if (receivers.isEmpty) return;

  await _sendPushNotification(
    type: PushNotificationType.chatRequestAccepted,
    sender: sender,
    recipients: receivers,
    content: PushNotificationContent(
      title: sender.name,
      body: "ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚",
    ),
  );
}
```

#### é€šçŸ¥è¡¨ç¤ºä¾‹
```
é€šçŸ¥ãƒãƒ¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ ä½è—¤èŠ±å­                     â”‚
â”‚ ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ‰¿èªã•ã‚Œã¾ã— â”‚
â”‚ ãŸã€‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é€šçŸ¥ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### æ–¹é‡
é€šçŸ¥é€ä¿¡ã®å¤±æ•—ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡/æ‰¿èªå‡¦ç†ã®å¤±æ•—ã¨ã¯ã—ãªã„

#### å®Ÿè£…
```dart
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚
try {
  final toUser = await _getUserAccount(toUserId);
  if (toUser != null) {
    await _pushNotificationUsecase.sendChatRequest(toUser, message);
  }
} catch (e) {
  // é€šçŸ¥é€ä¿¡ã®ã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã™ï¼ˆãƒ­ã‚°ã®ã¿ï¼‰
  print('ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—: $e');
}
```

**ç†ç”±:**
- é€šçŸ¥ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®è£œåŠ©æ©Ÿèƒ½
- é€šçŸ¥å¤±æ•—ã§ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªä½“ã¯æˆåŠŸã¨ã™ã‚‹
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‹ã‚‰ç¢ºèªå¯èƒ½

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–
ç¾åœ¨ã¯Exception()ã‚’ä½¿ç”¨ã€‚å°†æ¥çš„ã«ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚’å®šç¾©å¯èƒ½ã€‚

```dart
class ChatRequestException implements Exception {
  final String message;
  ChatRequestException(this.message);

  @override
  String toString() => 'ChatRequestException: $message';
}
```

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å‡¦ç† | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¡¨ç¤º |
|--------|------|------|----------------|
| æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆå­˜åœ¨ | checkExistingRequest()ã§æ¤œå‡º | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "æ—¢ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã¾ã™" |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å¤±æ•— | Firestoreæ›¸ãè¾¼ã¿å¤±æ•— | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {è©³ç´°}" |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªå¤±æ•— | Firestoreã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¤±æ•— | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {è©³ç´°}" |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹å¤±æ•— | Firestoreå‰Šé™¤å¤±æ•— | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {è©³ç´°}" |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•— | Firestoreå‰Šé™¤å¤±æ•— | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {è©³ç´°}" |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸å­˜åœ¨ | getRequest()ã§ null | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" |
| é€šçŸ¥é€ä¿¡å¤±æ•— | FCMé€ä¿¡å¤±æ•— | **ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã™** | ï¼ˆè¡¨ç¤ºãªã—ï¼‰ |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ | Exception ã‚’ã‚¹ãƒ­ãƒ¼ | "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" |

### ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```dart
// Providerå´ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
@override
Widget build(BuildContext context, WidgetRef ref) {
  final asyncValue = ref.watch(receivedRequestsNotifierProvider);

  return asyncValue.when(
    data: (requests) => ListView(...),
    loading: () => Center(child: CircularProgressIndicator()),
    error: (error, _) => Center(
      child: Text('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'),
    ),
  );
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. Firestoreã‚¯ã‚¨ãƒªæœ€é©åŒ–

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```
Collection: chat_requests
Composite Index 1:
  - toUserId (Ascending)
  - status (Ascending)
  - createdAt (Descending)

Composite Index 2:
  - fromUserId (Ascending)
  - status (Ascending)
  - createdAt (Descending)
```

**ç†ç”±:**
- `where` + `orderBy` ã®ã‚¯ã‚¨ãƒªã«å¿…è¦
- å—ä¿¡/é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã®å–å¾—ã‚’é«˜é€ŸåŒ–

#### ã‚¯ã‚¨ãƒªåŠ¹ç‡åŒ–
```dart
// statusãƒ•ã‚£ãƒ«ã‚¿ã§ pending ã®ã¿å–å¾—ï¼ˆãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³å›é¿ï¼‰
.where('status', isEqualTo: 'pending')
.orderBy('createdAt', descending: true)
```

---

### 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒ 

#### autoDisposeã®æ´»ç”¨
```dart
@riverpod
class ReceivedRequestsNotifier extends _$ReceivedRequestsNotifier {
  @override
  Stream<List<ChatRequest>> build() {
    // ç”»é¢ã‚’é›¢ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    return ref.watch(chatRequestUsecaseProvider).streamReceivedRequests();
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
- ä¸è¦ãªFirestoreãƒªã‚¹ãƒŠãƒ¼ã®è‡ªå‹•è§£é™¤
- Firestoreã®èª²é‡‘å‰Šæ¸›

---

### 3. é€šçŸ¥é€ä¿¡ã®éåŒæœŸåŒ–

#### ä¸¦åˆ—å‡¦ç†
```dart
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã¨é€šçŸ¥é€ä¿¡ã‚’åˆ†é›¢
await _repository.sendRequest(...);  // å…ˆã«å®Œäº†

// é€šçŸ¥ã¯éåŒæœŸã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ
try {
  await _pushNotificationUsecase.sendChatRequest(...);
} catch (e) {
  // ã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã™
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ãŸã›ãªã„
- é€šçŸ¥å¤±æ•—ã§ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã¯æˆåŠŸ

---

### 4. UIæœ€é©åŒ–

#### ListViewæœ€é©åŒ–
```dart
ListView.builder(
  padding: const EdgeInsets.symmetric(vertical: 8),
  itemCount: requests.length,
  itemBuilder: (context, index) {
    // å¿…è¦ãªæ™‚ã ã‘Widgetæ§‹ç¯‰
    return ReceivedRequestCard(request: requests[index]);
  },
)
```

#### ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©åº¦ãªä½¿ç”¨
- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚ã®ã¿ï¼‰
- å‰Šé™¤æ™‚ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- éåº¦ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯é¿ã‘ã‚‹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å„ªå…ˆï¼‰

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢é€£ã®ãƒ«ãƒ¼ãƒ«
    match /chat_requests/{requestId} {

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ: è‡ªåˆ†ãŒé€ä¿¡è€…ã®å ´åˆã®ã¿
      allow create: if request.auth != null
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.status == 'pending'
        && request.resource.data.keys().hasAll(['id', 'fromUserId', 'toUserId', 'createdAt', 'status'])
        && (!request.resource.data.keys().hasAny(['message'])
            || request.resource.data.message.size() <= 200);

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èª­ã¿å–ã‚Š: é€ä¿¡è€…ã¾ãŸã¯å—ä¿¡è€…ã®ã¿
      allow read: if request.auth != null
        && (resource.data.fromUserId == request.auth.uid
            || resource.data.toUserId == request.auth.uid);

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ›´æ–°: å—ä¿¡è€…ãŒæ‰¿èªã™ã‚‹å ´åˆã®ã¿
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ "accepted" ã«å¤‰æ›´ã™ã‚‹æ“ä½œã®ã¿è¨±å¯
      allow update: if request.auth != null
        && resource.data.toUserId == request.auth.uid
        && resource.data.status == 'pending'
        && request.resource.data.status == 'accepted'
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰Šé™¤: é€ä¿¡è€…ã¾ãŸã¯å—ä¿¡è€…ã®ã¿
      // å´ä¸‹ï¼ˆå—ä¿¡è€…ï¼‰ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆé€ä¿¡è€…ï¼‰
      allow delete: if request.auth != null
        && (resource.data.fromUserId == request.auth.uid
            || resource.data.toUserId == request.auth.uid);
    }
  }
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
```dart
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
if (myUserId.isEmpty || toUserId.isEmpty) {
  throw Exception('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç„¡åŠ¹ã§ã™');
}

if (message != null && message.length > 200) {
  throw Exception('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯200æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
}

// è‡ªåˆ†è‡ªèº«ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²æ­¢
if (myUserId == toUserId) {
  throw Exception('è‡ªåˆ†è‡ªèº«ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã¾ã›ã‚“');
}
```

#### ã‚µãƒ¼ãƒãƒ¼å´ï¼ˆFirestore Rulesï¼‰
- é€ä¿¡è€…IDãŒèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ä¸€è‡´ã™ã‚‹ã“ã¨
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ "pending" ã§ä½œæˆã•ã‚Œã‚‹ã“ã¨
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå…¨ã¦å­˜åœ¨ã™ã‚‹ã“ã¨
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ200æ–‡å­—ä»¥å†…ã§ã‚ã‚‹ã“ã¨

---

### ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·

#### å´ä¸‹æ™‚ã®é€šçŸ¥ãªã—
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹æ™‚ã¯é€ä¿¡è€…ã«é€šçŸ¥ã‚’é€ã‚‰ãªã„
- ç›¸æ‰‹ã«æ‹’å¦ã•ã‚ŒãŸã“ã¨ãŒã‚ã‹ã‚‰ãªã„ï¼ˆå¿ƒç†çš„è² æ‹…è»½æ¸›ï¼‰
- ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼å¯¾ç­–

#### é€šçŸ¥åˆ¶å¾¡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€šçŸ¥ã‚’OFFã«ã§ãã‚‹ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
- ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•å´ä¸‹ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

---

## å°†æ¥ã®æ‹¡å¼µ

### å®Ÿè£…äºˆå®šæ©Ÿèƒ½

#### 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ‰åŠ¹æœŸé™
```dart
class ChatRequest {
  final DateTime? expiresAt;  // æœ‰åŠ¹æœŸé™ï¼ˆ7æ—¥å¾Œãªã©ï¼‰

  bool get isExpired => expiresAt != null && DateTime.now().isAfter(expiresAt);
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•å‰Šé™¤
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚ºã®ç®¡ç†

---

#### 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°åˆ¶é™
```dart
// 1æ—¥ã‚ãŸã‚Šã®é€ä¿¡å¯èƒ½æ•°ã‚’åˆ¶é™
Future<void> sendRequest(...) async {
  final todayCount = await _getTodayRequestCount();
  if (todayCount >= 10) {
    throw Exception('æœ¬æ—¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
  }
  // ...
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚¹ãƒ‘ãƒ é˜²æ­¢
- ã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›

---

#### 3. ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ã¨ã®çµ±åˆ
```dart
// ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯
Future<void> sendRequest(...) async {
  final isBlocked = await _checkBlockStatus(toUserId);
  if (isBlocked) {
    throw Exception('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã¾ã›ã‚“');
  }
  // ...
}

// ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•å´ä¸‹
Stream<List<ChatRequest>> streamReceivedRequests() {
  return _repository.streamReceivedRequests()
      .map((requests) => requests.where((req) => !_isBlockedUser(req.fromUserId)));
}
```

---

#### 4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```dart
// å®šå‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æä¾›
final templates = [
  "ã¯ã˜ã‚ã¾ã—ã¦ï¼ãŠè©±ã—ã—ã¾ã›ã‚“ã‹ï¼Ÿ",
  "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ã¦èˆˆå‘³ã‚’æŒã¡ã¾ã—ãŸ",
  "è¶£å‘³ãŒåˆã„ãã†ã§ã™ã­",
];

// ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠå¯èƒ½
```

---

#### 5. ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµ±è¨ˆæƒ…å ±
```dart
class ChatRequestStatistics {
  final int totalReceived;    // ç·å—ä¿¡æ•°
  final int totalSent;        // ç·é€ä¿¡æ•°
  final int acceptedCount;    // æ‰¿èªæ•°
  final int rejectedCount;    // å´ä¸‹æ•°
  final double acceptanceRate; // æ‰¿èªç‡
}
```

---

#### 6. ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥éŸ³
```dart
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡æ™‚ã®å°‚ç”¨é€šçŸ¥éŸ³
Future<void> sendChatRequest(...) async {
  await _sendPushNotification(
    ...
    metadata: PushNotificationMetadata(
      sound: 'chat_request_sound.mp3',  // ã‚«ã‚¹ã‚¿ãƒ éŸ³
    ),
  );
}
```

---

#### 7. ãƒªã‚¯ã‚¨ã‚¹ãƒˆç†ç”±ã®é¸æŠ
```dart
class ChatRequest {
  final String? reason;  // "å…±é€šã®è¶£å‘³" | "å‹é”ã«ãªã‚ŠãŸã„" | "è³ªå•ãŒã‚ã‚‹" ãªã©
}

// ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ç†ç”±ã‚’é¸æŠ
showDialog<ChatRequestReason>(
  context: context,
  builder: (context) => _SelectReasonDialog(),
);
```

---

## ãƒ†ã‚¹ãƒˆä»•æ§˜

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

#### Repository Test
```dart
test('sendRequest should create a pending request', () async {
  await repository.sendRequest(
    toUserId: 'user123',
    message: 'Hello',
  );

  verify(datasource.sendRequest(
    toUserId: 'user123',
    message: 'Hello',
  )).called(1);
});

test('checkExistingRequest should return null if no request exists', () async {
  when(datasource.checkExistingRequest('user123'))
    .thenAnswer((_) async => null);

  final result = await repository.checkExistingRequest('user123');

  expect(result, isNull);
});
```

#### UseCase Test
```dart
test('sendRequest should throw exception if request already exists', () async {
  when(repository.checkExistingRequest('user123'))
    .thenAnswer((_) async => mockChatRequest);

  expect(
    () => usecase.sendRequest(toUserId: 'user123'),
    throwsException,
  );
});

test('acceptRequest should create DM room', () async {
  when(repository.getRequest('req123'))
    .thenAnswer((_) async => mockChatRequest);

  await usecase.acceptRequest('req123');

  verify(dmOverviewUsecase.joinChat(mockChatRequest.fromUserId)).called(1);
});
```

---

### çµ±åˆãƒ†ã‚¹ãƒˆ

#### E2E Scenario 1: åŸºæœ¬ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ã
2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦é€ä¿¡
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã«é€šçŸ¥ãŒå±Šã
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼BãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’é–‹ã
7. ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
8. æ‰¿èªãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
9. ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»
10. ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã«æ‰¿èªé€šçŸ¥ãŒå±Šã
```

#### E2E Scenario 2: é‡è¤‡ãƒã‚§ãƒƒã‚¯
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒãƒ¦ãƒ¼ã‚¶ãƒ¼Bã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
2. å†åº¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã«1ä»¶ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

### ç›®æ¨™å€¤
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‡¦ç†: < 500ms
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§å–å¾—: < 300ms
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªå‡¦ç†: < 800msï¼ˆDMä½œæˆå«ã‚€ï¼‰
- é€šçŸ¥é€ä¿¡: < 1000msï¼ˆéåŒæœŸï¼‰

### æœ€é©åŒ–æŒ‡æ¨™
- Firestoreã‚¯ã‚¨ãƒªæ•°: æœ€å°åŒ–ï¼ˆ1ç”»é¢1-2ã‚¯ã‚¨ãƒªï¼‰
- ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒªã‚¹ãƒŠãƒ¼: å¿…è¦æœ€å°é™ï¼ˆautoDisposeï¼‰
- é€šçŸ¥é€ä¿¡: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ãŸã›ãªã„ï¼‰

---

## ä¾å­˜é–¢ä¿‚

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
```yaml
dependencies:
  cloud_firestore: ^4.x.x
  hooks_riverpod: ^2.x.x
  flutter_hooks: ^0.x.x
  uuid: ^4.x.x
  firebase_messaging: ^14.x.x
```

### å†…éƒ¨ä¾å­˜
```
Presentation Layer
  â”œâ”€â”€ pages/chat_request/
  â”‚   â”œâ”€â”€ chat_request_list_screen.dart
  â”‚   â””â”€â”€ send_chat_request_helper.dart
  â””â”€â”€ providers/chat_requests/
      â”œâ”€â”€ received_requests_notifier.dart
      â”œâ”€â”€ sent_requests_notifier.dart
      â””â”€â”€ pending_request_count_provider.dart
  â†“
Domain Layer
  â”œâ”€â”€ entity/
  â”‚   â””â”€â”€ chat_request.dart
  â”œâ”€â”€ usecases/
  â”‚   â”œâ”€â”€ chat_request_usecase.dart
  â”‚   â”œâ”€â”€ direct_message_overview_usecase.dart
  â”‚   â””â”€â”€ push_notification_usecase.dart
  â””â”€â”€ repository/
      â””â”€â”€ chat_request_repository_interface.dart
  â†“
Data Layer
  â”œâ”€â”€ repository/
  â”‚   â””â”€â”€ chat_request_repository.dart
  â””â”€â”€ datasource/
      â””â”€â”€ chat_request_datasource.dart
  â†“
Firebase
  â”œâ”€â”€ Firestore
  â””â”€â”€ Cloud Messaging
```

---

## å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|-----------|------|---------|
| 1.0.0 | 2025-10-09 | åˆç‰ˆãƒªãƒªãƒ¼ã‚¹ï¼ˆåŸºæœ¬æ©Ÿèƒ½å®Ÿè£…ï¼‰ |
| 1.1.0 | 2025-10-09 | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æ©Ÿèƒ½çµ±åˆï¼ˆãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼‰ |
| 1.2.0 | æœªå®š | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ‰åŠ¹æœŸé™ãƒ»æ•°åˆ¶é™å®Ÿè£…äºˆå®š |
| 1.3.0 | æœªå®š | ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½çµ±åˆäºˆå®š |

### v1.0.0ã®å®Ÿè£…å†…å®¹
- ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ãƒ»æ‰¿èªãƒ»å´ä¸‹ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- å—ä¿¡/é€ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
- æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
- SendChatRequestHelper ã«ã‚ˆã‚‹çµ±ä¸€çš„ãªã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ï¼‰

### v1.1.0ã®å®Ÿè£…å†…å®¹
- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æ©Ÿèƒ½ã®çµ±åˆ
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é€šçŸ¥
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªé€šçŸ¥
  - ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼ˆUserAccount.activeDevicesï¼‰
- PushNotificationUsecase ã¸ã®ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
  - `sendChatRequest(UserAccount, String?)`
  - `sendChatRequestAccepted(UserAccount)`
- ChatRequestUsecase ã§ã®é€šçŸ¥é€£æº
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆé€šçŸ¥å¤±æ•—ã¯æ¡ã‚Šã¤ã¶ã™ï¼‰

---

## ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|-----|------|
| ChatRequest | ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã®ãƒãƒ£ãƒƒãƒˆé–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ |
| pending | æœªæ‰¿èªã®çŠ¶æ…‹ |
| accepted | æ‰¿èªæ¸ˆã¿ã®çŠ¶æ…‹ï¼ˆãƒãƒ£ãƒƒãƒˆé–‹å§‹å¯èƒ½ï¼‰ |
| rejected | å´ä¸‹æ¸ˆã¿ã®çŠ¶æ…‹ |
| fromUserId | ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| toUserId | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| UseCase | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹å˜ä¸€è²¬ä»»ã®ã‚¯ãƒ©ã‚¹ |
| Repository | ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ |
| Datasource | Firestoreã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å±¤ |
| Provider (Notifier) | Riverpodã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†ã‚¯ãƒ©ã‚¹ |
| Helper | å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ |
| FCM | Firebase Cloud Messagingï¼ˆãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼‰ |

---

## å‚è€ƒè³‡æ–™

### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- Domainå±¤ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©
- Dataå±¤ã§å…·ä½“çš„å®Ÿè£…ã‚’æä¾›
- ä¾å­˜æ€§ã®é€†è»¢åŸå‰‡ï¼ˆDIPï¼‰ã‚’é©ç”¨

### Riverpodï¼ˆCode Generationï¼‰
- `@riverpod`: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è‡ªå‹•ç”Ÿæˆ
- `StreamProvider`: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ç›£è¦–
- `autoDispose`: è‡ªå‹•ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾

### Firestore Best Practices
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ï¼ˆè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
- Security Rules ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã®æœ€å°åŒ–

### Firebase Cloud Messaging
- ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œï¼ˆactiveDevicesï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ´»ç”¨
- é€šçŸ¥ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

---

## ã¾ã¨ã‚

ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã¯ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åŸºã¥ãã€ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤ï¼š

1. **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢**: Presentation / Domain / Data ã®æ˜ç¢ºãªåˆ†é›¢
2. **ä¾å­˜æ€§ã®é€†è»¢**: Domainå±¤ãŒDataå±¤ã®è©³ç´°ã‚’çŸ¥ã‚‰ãªã„
3. **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
4. **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã«æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–
5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿è­·**: æ‰¿èªãƒ™ãƒ¼ã‚¹ã®å®‰å…¨ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
6. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒ ç®¡ç†ãƒ»é€šçŸ¥ã®éåŒæœŸåŒ–
7. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Firestore Security Rules ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
8. **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: å´ä¸‹æ™‚ã®é€šçŸ¥ãªã—ã€ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ã¨ã®çµ±åˆï¼ˆå°†æ¥ï¼‰
9. **é€šçŸ¥çµ±åˆ**: ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œã®ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥

ã“ã®ä»•æ§˜æ›¸ã«å¾“ã†ã“ã¨ã§ã€ä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ã®é«˜ã„ãƒãƒ£ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã‚’å®Ÿç¾ã§ãã‚‹ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ9æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1.0
**ä½œæˆè€…**: é–‹ç™ºãƒãƒ¼ãƒ 
