# チャットリクエスト機能 テスト手順書

## 概要

チャットリクエスト機能は、フォロー・フォロワー関係なく誰にでもチャットリクエストを送信できる機能です。

### 主な機能

- ✅ リクエストの送信
- ✅ リクエストの受信・一覧表示
- ✅ リクエストの承認（チャットルーム作成）
- ✅ リクエストの却下
- ✅ 送信済みリクエストの管理
- ✅ タイムライン画面でのリクエスト件数表示

---

## 事前準備

### 1. アプリのビルドと実行

```bash
# クリーンビルド（推奨）
flutter clean
flutter pub get

# iOSシミュレータで実行
flutter run

# または特定のデバイスで実行
flutter devices  # デバイス一覧を確認
flutter run -d <device-id>
```

### 2. テストアカウントの準備

以下の3つのアカウントを用意してください：

- **アカウントA**: リクエスト送信者
- **アカウントB**: リクエスト受信者
- **アカウントC**: 追加テスト用（オプション）

---

## テストケース

### テストケース1: リクエスト送信

#### 目的
ユーザーが他のユーザーにチャットリクエストを送信できることを確認

#### 手順
1. **アカウントA**でログイン
2. アカウントBのプロフィール画面を開く
3. 画面下部の「メッセージを送る」ボタンをタップ
4. リクエスト送信ダイアログが表示される
5. メッセージ欄に任意のメッセージを入力（例: "よろしくお願いします！"）
6. 「送信」ボタンをタップ

#### 期待される結果
- ✅ 「リクエストを送信しました」というSnackBarが表示される
- ✅ ダイアログが閉じる

---

### テストケース2: リクエスト受信の確認

#### 目的
受信したリクエストがタイムライン画面とリクエスト一覧画面に表示されることを確認

#### 手順
1. **アカウントB**でログイン
2. タイムライン画面を開く
3. 画面上部の「リクエスト」カードを確認
4. 「リクエスト」カードをタップ

#### 期待される結果
- ✅ リクエストカードに「1」と件数が表示される
- ✅ リクエスト一覧画面に遷移する
- ✅ 「受信」タブにアカウントAからのリクエストが表示される
- ✅ リクエストカードに送信者の名前、プロフィール画像、メッセージ、送信時刻が表示される

---

### テストケース3: リクエスト承認

#### 目的
リクエストを承認するとチャットルームが作成されることを確認

#### 手順
1. **アカウントB**のリクエスト一覧画面（受信タブ）
2. アカウントAからのリクエストの「承認」ボタンをタップ

#### 期待される結果
- ✅ チャット画面に遷移する
- ✅ チャット画面のタイトルがアカウントAの名前になっている
- ✅ 戻ってチャット一覧画面を開くと、アカウントAとのチャットルームが作成されている

---

### テストケース4: チャット機能の確認

#### 目的
承認後にチャット機能が正常に動作することを確認

#### 手順
1. **アカウントB**からアカウントAへメッセージを送信（例: "こんにちは！"）
2. **アカウントA**でログインし直す
3. チャット一覧画面を開く
4. アカウントBとのチャットを開く

#### 期待される結果
- ✅ アカウントBからのメッセージが表示される
- ✅ アカウントAからも返信できる
- ✅ メッセージのやり取りが双方向で正常に動作する

---

### テストケース5: リクエスト却下

#### 目的
リクエストを却下すると削除されることを確認

#### 手順
1. **アカウントC**から**アカウントB**へリクエストを送信
2. **アカウントB**でログイン
3. リクエスト一覧画面を開く
4. アカウントCからのリクエストの「却下」ボタンをタップ
5. 確認ダイアログで「却下」を選択

#### 期待される結果
- ✅ 「リクエストを却下しました」というSnackBarが表示される
- ✅ リクエストが一覧から削除される
- ✅ タイムライン画面のリクエスト件数が減る

---

### テストケース6: 送信済みリクエストの確認

#### 目的
自分が送信したリクエストを確認できることを確認

#### 手順
1. **アカウントA**でログイン
2. リクエスト一覧画面を開く（タイムライン画面の「リクエスト」カードから）
3. 「送信」タブをタップ

#### 期待される結果
- ✅ アカウントBへの送信済みリクエストが表示される
- ✅ リクエストカードに「送信済み」と表示される
- ✅ 「キャンセル」ボタンが表示される

---

### テストケース7: リクエストのキャンセル

#### 目的
送信したリクエストをキャンセルできることを確認

#### 手順
1. **アカウントA**の送信済みリクエスト一覧
2. 任意のリクエストの「キャンセル」ボタンをタップ
3. 確認ダイアログで「キャンセル」を選択

#### 期待される結果
- ✅ 「リクエストをキャンセルしました」というSnackBarが表示される
- ✅ リクエストが送信一覧から削除される
- ✅ 受信者側でもリクエストが削除される

---

### テストケース8: 重複リクエストの防止

#### 目的
同じユーザーに重複してリクエストを送信できないことを確認

#### 手順
1. **アカウントA**でログイン
2. アカウントBのプロフィール画面を開く
3. 「メッセージを送る」ボタンをタップ

#### 期待される結果
- ✅ 「既にリクエストを送信しています」というSnackBarが表示される
- ✅ リクエスト送信ダイアログは表示されない

---

### テストケース9: 既存チャットがある場合の挙動

#### 目的
既にチャットルームがあるユーザーの場合、直接チャット画面に遷移することを確認

#### 手順
1. **アカウントB**（既にアカウントAとチャット中）でログイン
2. アカウントAのプロフィール画面を開く
3. 「メッセージを送る」ボタンをタップ

#### 期待される結果
- ✅ リクエスト送信ダイアログは表示されない
- ✅ 直接アカウントAとのチャット画面に遷移する

---

### テストケース10: リクエスト件数のリアルタイム更新

#### 目的
リクエスト件数がリアルタイムで更新されることを確認

#### 手順
1. **アカウントB**でログイン（タイムライン画面を開いたまま）
2. 別のデバイスまたはシミュレータで**アカウントD**からリクエストを送信
3. アカウントBのタイムライン画面を確認

#### 期待される結果
- ✅ タイムライン画面のリクエストカードの件数が自動的に更新される
- ✅ アプリを再起動しなくてもリアルタイムで反映される

---

## エラーケースのテスト

### エラーケース1: ネットワークエラー

#### 手順
1. デバイスの機内モードをONにする
2. リクエストを送信してみる

#### 期待される結果
- ✅ 適切なエラーメッセージが表示される
- ✅ アプリがクラッシュしない

---

### エラーケース2: 相手がアカウント削除した場合

#### 手順
1. リクエストを送信後、受信者がアカウントを削除する
2. 送信者のリクエスト一覧を確認

#### 期待される結果
- ✅ エラーが発生せず、適切に処理される
- ✅ リクエスト一覧に表示されるか、エラー表示がある

---

## パフォーマンステスト

### 大量リクエストの処理

#### 手順
1. 複数のアカウント（10件以上）からリクエストを受信
2. リクエスト一覧画面を開く
3. スクロールして全件表示できるか確認

#### 期待される結果
- ✅ スムーズにスクロールできる
- ✅ 画像の読み込みが適切に行われる
- ✅ メモリリークが発生しない

---

## チェックリスト

動作確認時は以下のチェックリストを使用してください：

- [ ] リクエスト送信が正常に動作する
- [ ] リクエスト受信が正常に表示される
- [ ] リクエスト承認でチャットルームが作成される
- [ ] リクエスト却下で削除される
- [ ] 送信済みリクエストが確認できる
- [ ] リクエストキャンセルが動作する
- [ ] 重複リクエストが防止される
- [ ] 既存チャットがある場合は直接遷移する
- [ ] タイムライン画面のリクエスト件数が正しく表示される
- [ ] リクエスト件数がリアルタイムで更新される
- [ ] ユーザー画像が正しく表示される
- [ ] メッセージ付きリクエストが正しく表示される
- [ ] エラーハンドリングが適切に動作する
- [ ] パフォーマンスに問題がない

---

## トラブルシューティング

### Firestoreインデックスエラーが出る場合

```bash
firebase deploy --only firestore:indexes
```

を実行して、インデックスをデプロイしてください。

### ビルドエラーが出る場合

```bash
flutter clean
flutter pub get
flutter run
```

を実行してクリーンビルドしてください。

### データが表示されない場合

1. Firebaseコンソールでデータを確認
2. `chat_requests`コレクションにドキュメントが作成されているか確認
3. セキュリティルールが適切に設定されているか確認

---

## 関連ドキュメント

- [アーキテクチャ設計](../architecture/chat-request-architecture.md)
- [API仕様](../api-spec-md.md)
- [データベース設計](../database-md.md)

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-XX-XX | 1.0.0 | 初版作成 |
