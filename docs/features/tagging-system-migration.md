# ã‚¿ã‚°ã‚·ã‚¹ãƒ†ãƒ  æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦
ã‚¿ã‚°ã‚·ã‚¹ãƒ†ãƒ MVPã®å®Ÿè£…ã«ãŠã„ã¦ã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã—ãŸéš›ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ãŒè‡ªå‹•çš„ã«åˆæœŸåŒ–ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹å¼: ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰åˆæœŸåŒ–

### æ¡ç”¨ç†ç”±
1. **ãƒãƒƒãƒå‡¦ç†ä¸è¦** - å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€æ‹¬å‡¦ç†ã™ã‚‹å¿…è¦ãŒãªã„
2. **æ®µéšçš„å°å…¥** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ç‚¹ã§åˆæœŸåŒ–
3. **å®‰å…¨æ€§** - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«å½±éŸ¿
4. **ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡** - ä¸è¦ãªFirestoreæ›¸ãè¾¼ã¿ã‚’å‰Šæ¸›

### å‹•ä½œæ–¹å¼
**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ã‚°é–¢é€£ç”»é¢ã‚’åˆã‚ã¦é–‹ã„ãŸæ™‚
**å‡¦ç†**: ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°6ç¨®ã‚’è‡ªå‹•ä½œæˆ
**é€šçŸ¥**: ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ã§ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€ã¨è¡¨ç¤º

---

## å®Ÿè£…å†…å®¹

### 1. ãƒã‚¤ã‚¿ã‚°ä¸€è¦§ç”»é¢ã§ã®åˆæœŸåŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/presentation/pages/user_tag/my_tags_page.dart`

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```dart
// æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ: ã‚¿ã‚°ãŒç©ºã®å ´åˆã¯è‡ªå‹•åˆæœŸåŒ–
if (allTags.isEmpty && !isInitializing.value) {
  isInitializing.value = true;
  Future.microtask(() async {
    try {
      await usecase.initializeSystemTags();
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ'),
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('ã‚¿ã‚°ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      isInitializing.value = false;
    }
  });
  return const Center(
    child: Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        CircularProgressIndicator(),
        SizedBox(height: 16),
        Text('ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...'),
      ],
    ),
  );
}
```

**å‹•ä½œãƒ•ãƒ­ãƒ¼**:
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¤ã‚¿ã‚°ç”»é¢ã‚’é–‹ã
2. StreamBuilder ã§ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
3. ã‚¿ã‚°ãŒç©ºï¼ˆallTags.isEmptyï¼‰ã®å ´åˆ
   â†“
4. åˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆisInitializing = trueï¼‰
5. ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°6ç¨®ã‚’ Firestore ã«ä½œæˆ
6. æˆåŠŸæ™‚: ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼è¡¨ç¤º
7. å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
8. åˆæœŸåŒ–ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã’ã‚‹ï¼ˆisInitializing = falseï¼‰
   â†“
9. StreamBuilder ãŒè‡ªå‹•çš„ã«å†æç”»
10. ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### 2. ã‚¿ã‚°é¸æŠã‚·ãƒ¼ãƒˆã§ã®åˆæœŸåŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/presentation/components/user_tag/tag_button.dart`

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```dart
// æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ: ã‚¿ã‚°ãŒç©ºã®å ´åˆã¯è‡ªå‹•åˆæœŸåŒ–
if (allTags.isEmpty && !isInitializing.value) {
  isInitializing.value = true;
  Future.microtask(() async {
    try {
      await usecase.initializeSystemTags();
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ'),
            duration: Duration(seconds: 2),
          ),
        );
      }
    } catch (e) {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('åˆæœŸåŒ–å¤±æ•—: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } finally {
      isInitializing.value = false;
    }
  });
  return const Center(
    child: Padding(
      padding: EdgeInsets.all(32),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          CircularProgressIndicator(),
          SizedBox(height: 16),
          Text('ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...'),
        ],
      ),
    ),
  );
}
```

**å‹•ä½œãƒ•ãƒ­ãƒ¼**:
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã§ ğŸ·ï¸ ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
2. ã‚¿ã‚°é¸æŠã‚·ãƒ¼ãƒˆãŒé–‹ã
3. StreamBuilder ã§ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
4. ã‚¿ã‚°ãŒç©ºã®å ´åˆ
   â†“
5. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
6. ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°6ç¨®ã‚’ Firestore ã«ä½œæˆ
7. ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼è¡¨ç¤º
   â†“
8. ã‚¿ã‚°é¸æŠã‚·ãƒ¼ãƒˆã«6ã¤ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### 3. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸåŒ–ï¼ˆæ—¢å­˜å®Ÿè£…ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/presentation/providers/shared/users/my_user_account_notifier.dart`

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```dart
Future<void> _initializeSystemTagsIfNeeded() async {
  try {
    final tagUsecase = ref.read(userTagUsecaseProvider);
    final tags = await tagUsecase.watchMyTags().first;

    // ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿åˆæœŸåŒ–
    if (tags.isEmpty) {
      await tagUsecase.initializeSystemTags();
    }
  } catch (e) {
    // ã‚¿ã‚°åˆæœŸåŒ–ã®å¤±æ•—ã¯è‡´å‘½çš„ã§ã¯ãªã„ã®ã§ãƒ­ã‚°ã®ã¿
    if (kDebugMode) {
      print('Failed to initialize system tags: $e');
    }
  }
}
```

**å‹•ä½œã‚¿ã‚¤ãƒŸãƒ³ã‚°**:
- ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œï¼‰
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãŸã‚UIå¾…æ©Ÿãªã—
- ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚é€šçŸ¥ã—ãªã„ï¼ˆç”»é¢ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å†è©¦è¡Œï¼‰

---

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

### æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒŠãƒªã‚ª

#### ã‚·ãƒŠãƒªã‚ª1: ãƒã‚¤ã‚¿ã‚°ç”»é¢ã‹ã‚‰åˆã‚¢ã‚¯ã‚»ã‚¹
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ–ã‚’é–‹ã
2. ã€ŒğŸ·ï¸ ãƒã‚¤ã‚¿ã‚°ã€ã‚’ã‚¿ãƒƒãƒ—
   â†“
3. ç”»é¢ä¸­å¤®ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
   ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...ã€
   â†“ ç´„1-2ç§’
4. ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼è¡¨ç¤º
   ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€
   â†“
5. ãƒã‚¤ã‚¿ã‚°ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚° 6ç¨®
   - ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚° ãªã—
   - å„ã‚¿ã‚°ã®äººæ•° 0äºº
```

#### ã‚·ãƒŠãƒªã‚ª2: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰åˆã‚¢ã‚¯ã‚»ã‚¹
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ã
2. ğŸ·ï¸ ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
   â†“
3. ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
   ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...ã€
   â†“ ç´„1-2ç§’
4. ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼è¡¨ç¤º
   ã€Œã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€
   â†“
5. ã‚¿ã‚°é¸æŠã‚·ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚° 6ç¨®ãŒé¸æŠå¯èƒ½
   - ã‚¿ã‚°ä»˜ã‘æ“ä½œãŒå¯èƒ½
```

#### ã‚·ãƒŠãƒªã‚ª3: ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’èµ·å‹•ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰
   â†“ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆæœŸåŒ–é–‹å§‹
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é€šå¸¸é€šã‚Šã‚¢ãƒ—ãƒªã‚’æ“ä½œå¯èƒ½
   â†“
3. å¾Œã§ãƒã‚¤ã‚¿ã‚°ç”»é¢ã‚’é–‹ã
   â†“
4. ã™ã§ã«åˆæœŸåŒ–æ¸ˆã¿
   - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãªã—
   - å³åº§ã«ã‚¿ã‚°ä¸€è¦§ãŒè¡¨ç¤º
```

### æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒŠãƒªã‚ª

```
1. æ–°è¦ç™»éŒ²/åˆå›ãƒ­ã‚°ã‚¤ãƒ³
   â†“ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§è‡ªå‹•åˆæœŸåŒ–
2. ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ãŒäº‹å‰ã«ä½œæˆã•ã‚Œã‚‹
   â†“
3. ãƒã‚¤ã‚¿ã‚°ç”»é¢ã‚’é–‹ã
   - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãªã—
   - å³åº§ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°6ç¨®ãŒè¡¨ç¤º
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
```
çŠ¶æ³: æ©Ÿå†…ãƒ¢ãƒ¼ãƒ‰ã€Wi-Fiåˆ‡æ–­æ™‚

å‹•ä½œ:
1. åˆæœŸåŒ–å‡¦ç†ãŒå¤±æ•—
2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆèµ¤è‰²ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ï¼‰
   ã€Œã‚¿ã‚°ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: [ã‚¨ãƒ©ãƒ¼å†…å®¹]ã€
3. ç”»é¢ã¯ç©ºã®çŠ¶æ…‹ã‚’ç¶­æŒ

ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§å¾Œã€ç”»é¢ã‚’å†åº¦é–‹ã
- è‡ªå‹•çš„ã«å†åˆæœŸåŒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹
```

### 2. Firestoreæ¨©é™ã‚¨ãƒ©ãƒ¼
```
çŠ¶æ³: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è¨­å®šãƒŸã‚¹

å‹•ä½œ:
1. åˆæœŸåŒ–å‡¦ç†ãŒå¤±æ•—
2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
   ã€Œã‚¿ã‚°ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: [Permission denied]ã€

å¯¾å‡¦:
- Firebase Consoleã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
- ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ããƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
```

### 3. é‡è¤‡åˆæœŸåŒ–ã®é˜²æ­¢
```
ä»•çµ„ã¿:
- isInitializing ãƒ•ãƒ©ã‚°ã§åŒæ™‚å®Ÿè¡Œã‚’é˜²æ­¢
- StreamBuilder ã®å†æç”»ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯

æ¡ä»¶:
if (allTags.isEmpty && !isInitializing.value)

çµæœ:
- 1å›ã®ã¿åˆæœŸåŒ–å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹
- è¤‡æ•°ã®ã‚¿ãƒƒãƒ—ã§ã‚‚å®‰å…¨
```

---

## Firestoreãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### åˆæœŸåŒ–å¾Œã®ãƒ‡ãƒ¼ã‚¿

**ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: `users/{userId}/tags/`

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¾‹**:
```json
{
  "oshi": {
    "tagId": "oshi",
    "name": "æ¨ã—",
    "icon": "âœ¨",
    "color": "#9370DB",
    "priority": 5,
    "isSystemTag": true,
    "showInTimeline": true,
    "enableNotifications": true,
    "userCount": 0,
    "createdAt": Timestamp(2025, 10, 6, ...),
    "updatedAt": Timestamp(2025, 10, 6, ...)
  },
  "friend": {
    "tagId": "friend",
    "name": "ãƒ•ãƒ¬ãƒ³ãƒ‰",
    "icon": "â­",
    "color": "#FFD700",
    "priority": 4,
    "isSystemTag": true,
    "showInTimeline": true,
    "enableNotifications": true,
    "userCount": 0,
    "createdAt": Timestamp(2025, 10, 6, ...),
    "updatedAt": Timestamp(2025, 10, 6, ...)
  },
  // ... æ®‹ã‚Š4ã¤ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°
}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
```firestore
match /users/{userId}/tags/{tagId} {
  // èª­ã¿å–ã‚Šæ¨©é™: æœ¬äººã®ã¿
  allow read: if request.auth != null && request.auth.uid == userId;

  // ä½œæˆãƒ»æ›´æ–°æ¨©é™: æœ¬äººã®ã¿
  allow create, update: if request.auth != null && request.auth.uid == userId;

  // å‰Šé™¤æ¨©é™: æœ¬äººã®ã¿ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã¯å‰Šé™¤ä¸å¯ï¼‰
  allow delete: if request.auth != null
                && request.auth.uid == userId
                && resource.data.isSystemTag == false;
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿

### Firestoreèª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿

**1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šã®åˆæœŸåŒ–ã‚³ã‚¹ãƒˆ**:
```
æ›¸ãè¾¼ã¿: 6å›ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°6ç¨® Ã— 1å›ï¼‰
èª­ã¿å–ã‚Š: 1å›ï¼ˆåˆæœŸåŒ–æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ï¼‰
åˆè¨ˆ: 7å›ã®Firestoreæ“ä½œ
```

**å…¨ä½“ã®å½±éŸ¿**:
```
æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: 10,000äººã¨ä»®å®š
åˆæœŸåŒ–ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼: 10,000äººï¼ˆå…¨å“¡ï¼‰

ç·Firestoreæ“ä½œ: 70,000å›
- æ›¸ãè¾¼ã¿: 60,000å›
- èª­ã¿å–ã‚Š: 10,000å›

æ®µéšçš„å®Ÿè¡Œ:
- 1æ—¥ç›®: 1,000äººãŒã‚¢ã‚¯ã‚»ã‚¹ â†’ 7,000å›
- 1é€±é–“: 5,000äººãŒã‚¢ã‚¯ã‚»ã‚¹ â†’ 35,000å›
- 1ãƒ¶æœˆ: 8,000äººãŒã‚¢ã‚¯ã‚»ã‚¹ â†’ 56,000å›
- æ®‹ã‚Š: 2,000äººï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

â†’ æ€¥æ¿€ãªè² è·é›†ä¸­ãªã—
```

### ã‚³ã‚¹ãƒˆè©¦ç®—ï¼ˆFirebaseãƒ—ãƒ©ãƒ³ï¼‰

**Firestoreæ–™é‡‘**:
```
æ›¸ãè¾¼ã¿: $0.18 / 100,000å›
èª­ã¿å–ã‚Š: $0.06 / 100,000å›

åˆæœŸåŒ–ã‚³ã‚¹ãƒˆï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰:
- æ›¸ãè¾¼ã¿ 60,000å›: $0.108
- èª­ã¿å–ã‚Š 10,000å›: $0.006
åˆè¨ˆ: ç´„ $0.11

â†’ éå¸¸ã«ä½ã‚³ã‚¹ãƒˆ
```

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### åˆæœŸåŒ–çŠ¶æ³ã®ç¢ºèª

**Firebase Console**:
```
1. Firestore Database ã‚’é–‹ã
2. users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
3. ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’é¸æŠ
4. tags ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª

âœ“ 6ã¤ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ï¼‰ãŒå­˜åœ¨ã™ã‚‹
âœ“ å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®isSystemTagãŒtrueã§ã‚ã‚‹
```

**ã‚¢ãƒ—ãƒªãƒ­ã‚°**:
```dart
// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ç¢ºèª
if (kDebugMode) {
  print('System tags initialized for user: $userId');
}
```

### åˆæœŸåŒ–å¤±æ•—ã®æ¤œå‡º

**ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª**:
```
Firebase Console > Functions > Logs
ã¾ãŸã¯
ã‚¢ãƒ—ãƒªã®ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ¬ãƒãƒ¼ãƒˆï¼ˆCrashlyticsç­‰ï¼‰

ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³:
1. "Permission denied" â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ç¢ºèª
2. "Network error" â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šç¢ºèª
3. "Timeout" â†’ Firestoreæ¥ç¶šç¢ºèª
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚¿ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **:
- åˆæœŸåŒ–å‡¦ç†ãŒå¤±æ•—ã—ã¦ã„ã‚‹
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å•é¡Œ

**å¯¾å‡¦æ³•**:
```
1. ã‚¢ãƒ—ãƒªã‚’å®Œå…¨ã«å†èµ·å‹•
2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª
3. ãƒã‚¤ã‚¿ã‚°ç”»é¢ã‚’å†åº¦é–‹ã
4. Firebase Consoleã§ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ç¢ºèª
```

### Q2: åˆæœŸåŒ–ãŒè¤‡æ•°å›å®Ÿè¡Œã•ã‚Œã‚‹

**åŸå› **:
- isInitializingãƒ•ãƒ©ã‚°ã®ç«¶åˆ
- StreamBuilderã®å†æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°

**å¯¾å‡¦æ³•**:
```dart
// ã™ã§ã«å®Ÿè£…æ¸ˆã¿
if (allTags.isEmpty && !isInitializing.value) {
  // 1å›ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹
}
```

### Q3: ã€ŒåˆæœŸåŒ–ã—ã¦ã„ã¾ã™...ã€ã‹ã‚‰é€²ã¾ãªã„

**åŸå› **:
- Firestoreæ›¸ãè¾¼ã¿ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«æ‹’å¦

**å¯¾å‡¦æ³•**:
```
1. ã‚¢ãƒ—ãƒªã‚’å¼·åˆ¶çµ‚äº†
2. å†èµ·å‹•
3. ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆ:
   - Firebase Consoleã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
   - ãƒ­ã‚°ã‚’ç¢ºèª
```

---

## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

ä¸‡ãŒä¸€ã€å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã€‚

### 1. ã‚¢ãƒ—ãƒªå´ã®ç„¡åŠ¹åŒ–

**æ–¹æ³•**: ã‚¿ã‚°ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–

```dart
// lib/presentation/v2/pages/home/profile_page.dart
// ãƒã‚¤ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

/*
{
  'icon': Icons.label,
  'title': 'ãƒã‚¤ã‚¿ã‚°',
  'description': 'ã‚¿ã‚°ã®ç®¡ç†',
  'route': 'tags',
},
*/
```

### 2. åˆæœŸåŒ–å‡¦ç†ã®ç„¡åŠ¹åŒ–

**æ–¹æ³•**: è‡ªå‹•åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—

```dart
// ä¸€æ™‚çš„ã«åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
if (allTags.isEmpty && !isInitializing.value) {
  // ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  // Future.microtask(() async { ... });

  // ä»£ã‚ã‚Šã«ç©ºçŠ¶æ…‹ã‚’è¡¨ç¤º
  return const Center(
    child: Text('ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã§ã™'),
  );
}
```

### 3. Firestoreãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰

**è­¦å‘Š**: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™

```javascript
// Firebase Functions ã§ä¸€æ‹¬å‰Šé™¤
const admin = require('firebase-admin');
const db = admin.firestore();

async function deleteAllUserTags() {
  const usersSnapshot = await db.collection('users').get();

  for (const userDoc of usersSnapshot.docs) {
    const tagsSnapshot = await userDoc.ref.collection('tags').get();

    for (const tagDoc of tagsSnapshot.docs) {
      await tagDoc.ref.delete();
    }
  }
}
```

---

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### 1. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸€æ‹¬åˆæœŸåŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ç›®çš„**: äº‹å‰ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆæœŸåŒ–

**å®Ÿè£…**:
```javascript
// Cloud Functions for Firebase
exports.migrateExistingUsers = functions.https.onRequest(async (req, res) => {
  const usersSnapshot = await admin.firestore().collection('users').get();

  const batch = admin.firestore().batch();
  let count = 0;

  for (const userDoc of usersSnapshot.docs) {
    const userId = userDoc.id;
    const tagsSnapshot = await userDoc.ref.collection('tags').get();

    if (tagsSnapshot.empty) {
      // ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚°ã‚’ä½œæˆ
      for (const systemTag of SYSTEM_TAGS) {
        const tagRef = userDoc.ref.collection('tags').doc(systemTag.tagId);
        batch.set(tagRef, systemTag);
        count++;
      }
    }

    if (count >= 500) {
      await batch.commit();
      count = 0;
    }
  }

  if (count > 0) {
    await batch.commit();
  }

  res.send('Migration completed');
});
```

### 2. åˆæœŸåŒ–çŠ¶æ…‹ã®çµ±è¨ˆ

**ç›®çš„**: ã©ã‚Œãã‚‰ã„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆæœŸåŒ–æ¸ˆã¿ã‹ç¢ºèª

**å®Ÿè£…**:
```javascript
// Analytics ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
analytics.logEvent('tag_system_initialized', {
  user_id: userId,
  initialization_source: 'my_tags_page', // or 'tag_selection_sheet'
  timestamp: Date.now()
});
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ

**ç›®çš„**: åˆæœŸåŒ–å¤±æ•—ã®è©³ç´°ã‚’åé›†

**å®Ÿè£…**:
```dart
try {
  await usecase.initializeSystemTags();
} catch (e, stackTrace) {
  // Crashlytics ã«ãƒ¬ãƒãƒ¼ãƒˆ
  FirebaseCrashlytics.instance.recordError(e, stackTrace, reason: 'Tag initialization failed');
}
```

---

## ã¾ã¨ã‚

### âœ… å®Ÿè£…å®Œäº†äº‹é …
- ãƒã‚¤ã‚¿ã‚°ä¸€è¦§ç”»é¢ã§ã®è‡ªå‹•åˆæœŸåŒ–
- ã‚¿ã‚°é¸æŠã‚·ãƒ¼ãƒˆã§ã®è‡ªå‹•åˆæœŸåŒ–
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ï¼ˆã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ï¼‰

### âœ… åˆ©ç‚¹
- ãƒãƒƒãƒå‡¦ç†ä¸è¦
- æ®µéšçš„å°å…¥
- ä½ã‚³ã‚¹ãƒˆ
- ã‚¨ãƒ©ãƒ¼å½±éŸ¿ç¯„å›²ãŒé™å®šçš„

### âš ï¸ æ³¨æ„ç‚¹
- åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«1-2ç§’ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒã‚ã‚‹
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤ãŒå¿…è¦

### ğŸ“Š æƒ³å®šå‹•ä½œ
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®95%ã¯1é€±é–“ä»¥å†…ã«åˆæœŸåŒ–ã•ã‚Œã‚‹
- éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æœªåˆæœŸåŒ–ã®ã¾ã¾ï¼ˆå•é¡Œãªã—ï¼‰
- ç·Firestoreã‚³ã‚¹ãƒˆã¯$0.11æœªæº€

---

**æœ€çµ‚æ›´æ–°**: 2025-10-06
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
