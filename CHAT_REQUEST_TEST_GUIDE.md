# チャットリクエスト機能 テスト手順書・確認事項資料

## 📋 目次
1. [機能概要](#機能概要)
2. [アーキテクチャ構成](#アーキテクチャ構成)
3. [ユーザーストーリー（US）](#ユーザーストーリーus)
4. [機能一覧](#機能一覧)
5. [テスト手順](#テスト手順)
6. [確認チェックリスト](#確認チェックリスト)
7. [エラーケーステスト](#エラーケーステスト)
8. [通知機能テスト](#通知機能テスト)
9. [既知の制約・注意事項](#既知の制約注意事項)

---

## 機能概要

### 目的
ユーザー間でチャットを開始する前に「リクエスト」を送信し、承認を得てからチャットを開始できる機能。
スパムやいきなりのメッセージを防ぎ、ユーザー体験を向上させる。

### 主要機能
- ✅ チャットリクエストの送信（メッセージ付き可能）
- ✅ 受信リクエストの確認・承認・却下
- ✅ 送信リクエストの確認・キャンセル
- ✅ 既存チャット・リクエストの重複チェック
- ✅ リクエスト送信/承認時のプッシュ通知
- ✅ 承認後の自動チャット画面遷移

---

## アーキテクチャ構成

### レイヤー構造
```
UI Layer (Presentation)
├── chat_request_list_screen.dart        # リクエスト一覧画面
├── send_chat_request_helper.dart        # リクエスト送信ヘルパー
└── Providers
    ├── received_requests_notifier.dart  # 受信リクエスト状態管理
    └── sent_requests_notifier.dart      # 送信リクエスト状態管理

Domain Layer
├── usecases/
│   ├── chat_request_usecase.dart        # ビジネスロジック
│   └── push_notification_usecase.dart   # 通知ロジック
└── entity/
    └── chat_request.dart                # チャットリクエストエンティティ

Data Layer
├── repository/
│   └── chat_request_repository.dart     # データアクセス抽象化
└── datasource/
    └── chat_request_datasource.dart     # Firestore操作
```

### データモデル
```dart
class ChatRequest {
  final String id;                  // リクエストID
  final String fromUserId;          // 送信者ID
  final String toUserId;            // 受信者ID
  final Timestamp createdAt;        // 作成日時
  final ChatRequestStatus status;   // pending | accepted | rejected
  final String? message;            // 添付メッセージ（任意）
}
```

### Firestoreコレクション構造
```
/chat_requests/{requestId}
  - id: string
  - fromUserId: string
  - toUserId: string
  - createdAt: timestamp
  - status: "pending" | "accepted" | "rejected"
  - message: string | null
```

---

## ユーザーストーリー（US）

### US-1: 新規ユーザーへのチャットリクエスト送信
**As a** ユーザー
**I want to** 他のユーザーにチャットリクエストを送信できる
**So that** 相手の許可を得てからチャットを開始できる

**Acceptance Criteria:**
- メッセージ付きでリクエストを送信できる（最大200文字）
- メッセージなしでもリクエストを送信できる
- 既にチャットがある相手にはリクエストを送信できない
- 既にリクエストが存在する場合はエラーメッセージを表示
- 送信後、相手に通知が届く

### US-2: チャットリクエストの受信・承認
**As a** ユーザー
**I want to** 受信したチャットリクエストを確認・承認できる
**So that** 望まない相手とのチャットを避けられる

**Acceptance Criteria:**
- 受信リクエスト一覧で送信者情報を確認できる
- 送信者のプロフィールを確認できる（アイコンタップ）
- 添付メッセージがあれば表示される
- 承認すると自動的にチャット画面に遷移する
- 承認後、送信者に通知が届く

### US-3: チャットリクエストの却下・キャンセル
**As a** ユーザー
**I want to** 不要なリクエストを却下またはキャンセルできる
**So that** リストを整理できる

**Acceptance Criteria:**
- 受信リクエストを却下できる（確認ダイアログ表示）
- 送信リクエストをキャンセルできる（確認ダイアログ表示）
- 却下/キャンセル後、リストから即座に削除される
- 却下しても送信者には通知されない（プライバシー保護）

### US-4: リクエスト送信の複数エントリーポイント
**As a** ユーザー
**I want to** 様々な画面からリクエストを送信できる
**So that** スムーズにチャットを開始できる

**Acceptance Criteria:**
- ユーザープロフィール画面からメッセージボタンで送信
- フォロー/フォロワー画面からメッセージボタンで送信
- タイムライン画面から送信（実装確認）

---

## 機能一覧

### 1. リクエスト送信機能
**実装ファイル:** `send_chat_request_helper.dart`

**機能詳細:**
- 既存チャットルームの存在確認
- 既存リクエストの重複確認
- リクエスト送信ダイアログ表示
- メッセージ入力（任意、最大200文字）
- プッシュ通知送信

**エントリーポイント:**
1. **ユーザープロフィール画面**
   - ファイル: `user_profile_page.dart`
   - トリガー: メッセージボタン

2. **フォロー/フォロワー画面**
   - ファイル: `user_request_widget.dart`
   - トリガー: チャットアイコンボタン

3. **タイムライン画面**
   - ファイル: `timeline_square_sections.dart`
   - トリガー: （実装確認必要）

### 2. リクエスト一覧画面
**実装ファイル:** `chat_request_list_screen.dart`

**機能詳細:**
- タブ切り替え（受信/送信）
- リアルタイム更新（Firestoreストリーム）
- 空状態の表示
- ローディング状態の表示

**受信タブ機能:**
- リクエスト送信者情報表示
  - ユーザーアイコン
  - ユーザー名
  - オンライン状態
  - 送信時刻（相対時間表示）
- 添付メッセージ表示
- 承認ボタン（グラデーション）
- 却下ボタン（アウトライン）

**送信タブ機能:**
- リクエスト送信先情報表示
  - ユーザーアイコン
  - ユーザー名
  - "送信済み" バッジ
  - 送信時刻（相対時間表示）
- 添付メッセージ表示
- キャンセルボタン（赤色アウトライン）

### 3. 通知機能
**実装ファイル:** `push_notification_usecase.dart`, `chat_request_usecase.dart`

**通知タイプ:**
1. **チャットリクエスト送信通知**
   - タイプ: `PushNotificationType.chatRequest`
   - タイトル: 送信者名
   - 本文: 添付メッセージ または "チャットリクエストが届きました。"
   - マルチデバイス対応: ✅

2. **チャットリクエスト承認通知**
   - タイプ: `PushNotificationType.chatRequestAccepted`
   - タイトル: 承認者名
   - 本文: "チャットリクエストが承認されました。"
   - マルチデバイス対応: ✅

### 4. 状態管理
**Riverpod Providers:**

1. **receivedRequestsNotifierProvider**
   - ストリーム: 受信リクエスト一覧
   - メソッド:
     - `acceptRequest(ChatRequest)`: リクエスト承認
     - `rejectRequest(ChatRequest)`: リクエスト却下

2. **sentRequestsNotifierProvider**
   - ストリーム: 送信リクエスト一覧
   - メソッド:
     - `cancelRequest(ChatRequest)`: リクエストキャンセル

3. **pendingRequestCountProvider**
   - 機能: 未読リクエスト数カウント（バッジ表示用）

---

## テスト手順

### 🧪 事前準備

**必要なもの:**
- 2台のテストデバイス（または1台の実機 + 1台のエミュレータ）
- 2つのテストアカウント
  - ユーザーA（リクエスト送信者）
  - ユーザーB（リクエスト受信者）
- Firestore のテスト環境
- Firebase Cloud Messaging 設定（通知テスト用）

**初期状態確認:**
- [ ] ユーザーA, B間にチャットルームが存在しない
- [ ] ユーザーA, B間にpendingリクエストが存在しない
- [ ] 両デバイスで通知許可が有効

---

### 📱 テストケース1: 基本フロー - リクエスト送信から承認まで

#### ステップ1: リクエスト送信（ユーザーA）
**手順:**
1. ユーザーAでログイン
2. ユーザーBのプロフィール画面に遷移
3. メッセージボタンをタップ
4. チャットリクエストダイアログが表示されることを確認
5. メッセージ入力欄に「はじめまして！お話ししたいです」と入力
6. 「送信」ボタンをタップ

**期待される動作:**
- ✅ ダイアログが閉じる
- ✅ 「リクエストを送信しました」のスナックバー表示
- ✅ Firestoreに新しいリクエストが作成される
  ```
  /chat_requests/{requestId}
    - fromUserId: ユーザーAのID
    - toUserId: ユーザーBのID
    - status: "pending"
    - message: "はじめまして！お話ししたいです"
  ```
- ✅ ユーザーBのデバイスにプッシュ通知が届く
  - タイトル: ユーザーAの名前
  - 本文: "はじめまして！お話ししたいです"

**確認項目:**
- [ ] ダイアログが正しく表示される
- [ ] メッセージ入力が200文字まで可能
- [ ] 送信後にスナックバーが表示される
- [ ] Firestoreにデータが正しく保存される
- [ ] ユーザーBに通知が届く

#### ステップ2: リクエスト一覧確認（ユーザーA - 送信側）
**手順:**
1. ユーザーAでチャットリクエスト一覧画面に遷移
2. 「送信」タブを選択

**期待される動作:**
- ✅ 送信リクエスト一覧にユーザーBが表示される
- ✅ ユーザーBのアイコン、名前が正しく表示される
- ✅ "送信済み" バッジが表示される
- ✅ 送信時刻が相対時間で表示される（例: "1分前"）
- ✅ 添付メッセージが表示される
- ✅ 「リクエストをキャンセル」ボタンが表示される

**確認項目:**
- [ ] ユーザー情報が正しく表示される
- [ ] 送信時刻が適切にフォーマットされている
- [ ] メッセージ内容が正しく表示される
- [ ] UIが崩れていない

#### ステップ3: リクエスト受信確認（ユーザーB）
**手順:**
1. ユーザーBでログイン
2. 通知をタップしてアプリを開く（または直接リクエスト一覧画面へ）
3. チャットリクエスト一覧画面の「受信」タブを確認

**期待される動作:**
- ✅ 受信リクエスト一覧にユーザーAが表示される
- ✅ ユーザーAのアイコン、名前が正しく表示される
- ✅ ユーザーAのオンライン状態が表示される
- ✅ 送信時刻が相対時間で表示される
- ✅ 添付メッセージが表示される
- ✅ 「承認」ボタン（グラデーション）が表示される
- ✅ 「却下」ボタンが表示される

**確認項目:**
- [ ] ユーザー情報が正しく表示される
- [ ] オンライン状態が正確
- [ ] メッセージが正しく表示される
- [ ] ボタンのデザインが仕様通り

#### ステップ4: リクエスト承認（ユーザーB）
**手順:**
1. ユーザーBのリクエスト一覧画面で「承認」ボタンをタップ

**期待される動作:**
- ✅ チャット画面に自動遷移
- ✅ チャット相手がユーザーA
- ✅ Firestoreのリクエストステータスが "accepted" に更新
- ✅ DMルームが作成される
  ```
  /direct_messages/{roomId}
    - users: {
        [ユーザーAのID]: true,
        [ユーザーBのID]: true
      }
  ```
- ✅ ユーザーAのデバイスにプッシュ通知が届く
  - タイトル: ユーザーBの名前
  - 本文: "チャットリクエストが承認されました。"
- ✅ リクエストが両者のリスト（受信/送信）から消える

**確認項目:**
- [ ] チャット画面に正しく遷移する
- [ ] チャット機能が正常に動作する
- [ ] Firestoreのデータが正しく更新される
- [ ] DMルームが作成される
- [ ] ユーザーAに承認通知が届く
- [ ] リクエストリストから削除される

#### ステップ5: チャット動作確認
**手順:**
1. ユーザーBがチャット画面でメッセージを送信
2. ユーザーAでチャット画面を開く

**期待される動作:**
- ✅ メッセージがリアルタイムで送受信される
- ✅ 既存のチャット機能と同じ動作

**確認項目:**
- [ ] メッセージ送信が正常に動作
- [ ] リアルタイム更新が動作
- [ ] チャット履歴が保存される

---

### 📱 テストケース2: リクエスト却下フロー

#### ステップ1: 新規リクエスト送信
**手順:**
- テストケース1のステップ1と同じ
- ユーザーAがユーザーBにリクエストを送信

#### ステップ2: リクエスト却下（ユーザーB）
**手順:**
1. ユーザーBのリクエスト一覧画面で「却下」ボタンをタップ
2. 確認ダイアログが表示される
3. 「却下」ボタンをタップ

**期待される動作:**
- ✅ 確認ダイアログが表示される
  - タイトル: "リクエストを却下"
  - メッセージ: "このリクエストを却下しますか？"
- ✅ ダイアログで「却下」をタップ後、リストから削除される
- ✅ 「リクエストを却下しました」のスナックバー表示
- ✅ Firestoreからリクエストが削除される
- ✅ ユーザーAには通知が届かない（プライバシー保護）

**確認項目:**
- [ ] 確認ダイアログが表示される
- [ ] キャンセルボタンで操作を中断できる
- [ ] 却下後、リストから即座に削除される
- [ ] Firestoreから削除される
- [ ] ユーザーAに通知が届かない

#### ステップ3: 再送信可能確認
**手順:**
1. ユーザーAが再度ユーザーBにリクエストを送信

**期待される動作:**
- ✅ エラーなく再送信できる
- ✅ 新しいリクエストが作成される

**確認項目:**
- [ ] エラーなく再送信できる
- [ ] 新しいリクエストIDで作成される

---

### 📱 テストケース3: リクエストキャンセルフロー

#### ステップ1: 新規リクエスト送信
**手順:**
- ユーザーAがユーザーBにリクエストを送信

#### ステップ2: リクエストキャンセル（ユーザーA）
**手順:**
1. ユーザーAのリクエスト一覧画面の「送信」タブを開く
2. 「リクエストをキャンセル」ボタンをタップ
3. 確認ダイアログが表示される
4. 「キャンセル」ボタンをタップ

**期待される動作:**
- ✅ 確認ダイアログが表示される
  - タイトル: "リクエストをキャンセル"
  - メッセージ: "このリクエストをキャンセルしますか？"
- ✅ ダイアログで「キャンセル」をタップ後、リストから削除される
- ✅ 「リクエストをキャンセルしました」のスナックバー表示
- ✅ Firestoreからリクエストが削除される
- ✅ ユーザーBのリクエスト一覧からも削除される

**確認項目:**
- [ ] 確認ダイアログが表示される
- [ ] 「閉じる」ボタンで操作を中断できる
- [ ] キャンセル後、送信者のリストから削除される
- [ ] キャンセル後、受信者のリストから削除される
- [ ] Firestoreから削除される

---

### 📱 テストケース4: 重複チェック機能

#### テスト4-1: 既存チャットがある場合
**手順:**
1. ユーザーA, B間で既にチャットが存在する状態
2. ユーザーAがユーザーBのプロフィールでメッセージボタンをタップ

**期待される動作:**
- ✅ リクエスト送信ダイアログは表示されない
- ✅ 直接チャット画面に遷移する
- ✅ 既存のチャット履歴が表示される

**確認項目:**
- [ ] ダイアログが表示されない
- [ ] 既存チャット画面に遷移
- [ ] チャット履歴が保持されている

#### テスト4-2: 既にリクエストを送信済みの場合
**手順:**
1. ユーザーAがユーザーBにリクエストを送信済み（pending状態）
2. ユーザーAが再度ユーザーBのプロフィールでメッセージボタンをタップ

**期待される動作:**
- ✅ リクエスト送信ダイアログは表示されない
- ✅ スナックバーで「既にリクエストを送信しています」と表示

**確認項目:**
- [ ] ダイアログが表示されない
- [ ] エラーメッセージが表示される
- [ ] 重複リクエストが作成されない

#### テスト4-3: 既にリクエストを受信済みの場合
**手順:**
1. ユーザーBがユーザーAにリクエストを送信済み（pending状態）
2. ユーザーAがユーザーBのプロフィールでメッセージボタンをタップ

**期待される動作:**
- ✅ リクエスト送信ダイアログは表示されない
- ✅ スナックバーで「このユーザーから既にリクエストが届いています」と表示

**確認項目:**
- [ ] ダイアログが表示されない
- [ ] エラーメッセージが表示される
- [ ] 逆方向リクエストが作成されない

---

### 📱 テストケース5: メッセージなしリクエスト

#### ステップ1: メッセージなし送信
**手順:**
1. ユーザーAがユーザーBにリクエストを送信
2. メッセージ入力欄を空のまま「送信」ボタンをタップ

**期待される動作:**
- ✅ エラーなく送信される
- ✅ Firestoreの `message` フィールドが null
- ✅ ユーザーBの通知本文が「チャットリクエストが届きました。」

**確認項目:**
- [ ] メッセージなしで送信できる
- [ ] 通知のデフォルトメッセージが使用される
- [ ] リクエスト一覧でメッセージ欄が表示されない

---

### 📱 テストケース6: エントリーポイント確認

#### テスト6-1: ユーザープロフィール画面から
**手順:**
1. 任意のユーザープロフィール画面を開く
2. メッセージボタンをタップ

**確認項目:**
- [ ] ボタンが正しく配置されている
- [ ] タップでリクエストダイアログが表示される

#### テスト6-2: フォロー/フォロワー画面から
**手順:**
1. フォロー/フォロワー画面を開く
2. ユーザーカードのチャットアイコンをタップ

**確認項目:**
- [ ] アイコンが正しく配置されている
- [ ] タップでリクエストダイアログが表示される

#### テスト6-3: タイムライン画面から（要確認）
**手順:**
1. タイムライン画面を開く
2. （実装状況を確認）

**確認項目:**
- [ ] エントリーポイントの有無を確認
- [ ] あれば動作確認

---

### 📱 テストケース7: 空状態の表示

#### テスト7-1: 受信リクエストが0件
**手順:**
1. 受信リクエストが存在しない状態で一覧画面を開く
2. 「受信」タブを確認

**期待される動作:**
- ✅ 空状態UIが表示される
  - アイコン: inbox_outlined
  - テキスト: "リクエストはありません"

**確認項目:**
- [ ] 空状態UIが表示される
- [ ] デザインが適切

#### テスト7-2: 送信リクエストが0件
**手順:**
1. 送信リクエストが存在しない状態で一覧画面を開く
2. 「送信」タブを確認

**期待される動作:**
- ✅ 空状態UIが表示される
  - アイコン: send_outlined
  - テキスト: "送信したリクエストはありません"

**確認項目:**
- [ ] 空状態UIが表示される
- [ ] デザインが適切

---

### 📱 テストケース8: リアルタイム更新

#### ステップ1: 同時表示
**手順:**
1. ユーザーAとユーザーBの両方でリクエスト一覧画面を開く
2. ユーザーAが新規リクエストを送信

**期待される動作:**
- ✅ ユーザーAの「送信」タブにリアルタイムで追加される
- ✅ ユーザーBの「受信」タブにリアルタイムで追加される

**確認項目:**
- [ ] 送信側にリアルタイム反映
- [ ] 受信側にリアルタイム反映
- [ ] アニメーションなしで即座に表示

#### ステップ2: 承認/却下のリアルタイム反映
**手順:**
1. 両者がリクエスト一覧画面を開いている状態
2. ユーザーBがリクエストを承認または却下

**期待される動作:**
- ✅ ユーザーAの「送信」タブからリアルタイムで削除される
- ✅ ユーザーBの「受信」タブからリアルタイムで削除される

**確認項目:**
- [ ] 送信側からリアルタイム削除
- [ ] 受信側からリアルタイム削除

---

## 確認チェックリスト

### ✅ 機能動作確認

#### 基本機能
- [ ] リクエストを送信できる（メッセージあり）
- [ ] リクエストを送信できる（メッセージなし）
- [ ] リクエストを承認できる
- [ ] リクエストを却下できる
- [ ] リクエストをキャンセルできる
- [ ] 承認後にチャット画面に遷移する
- [ ] 承認後にチャット機能が動作する

#### 重複チェック
- [ ] 既存チャットがある場合、直接チャット画面へ遷移
- [ ] 既に送信済みリクエストがある場合、エラーメッセージ表示
- [ ] 既に受信済みリクエストがある場合、エラーメッセージ表示

#### UI表示
- [ ] 受信リクエスト一覧が正しく表示される
- [ ] 送信リクエスト一覧が正しく表示される
- [ ] 空状態が正しく表示される
- [ ] ローディング状態が正しく表示される
- [ ] エラー状態が正しく表示される

#### リアルタイム更新
- [ ] 新規リクエスト送信時にリアルタイム反映
- [ ] リクエスト承認時にリアルタイム反映
- [ ] リクエスト却下時にリアルタイム反映
- [ ] リクエストキャンセル時にリアルタイム反映

### ✅ 通知機能確認

#### プッシュ通知
- [ ] リクエスト送信時に通知が届く
- [ ] リクエスト承認時に通知が届く
- [ ] 通知のタイトルが正しい（送信者名）
- [ ] 通知の本文が正しい（メッセージまたはデフォルト文）
- [ ] 通知タップでアプリが開く
- [ ] マルチデバイス対応（複数デバイスに通知）

#### 通知設定
- [ ] 通知許可が無効の場合でもリクエスト機能は動作
- [ ] 通知送信エラーでもリクエスト送信は成功

### ✅ データ整合性確認

#### Firestore
- [ ] リクエストデータが正しく保存される
- [ ] ステータス更新が正しく反映される
- [ ] リクエスト削除が正しく実行される
- [ ] DMルーム作成が正しく実行される

#### クエリパフォーマンス
- [ ] 受信リクエストクエリが高速
- [ ] 送信リクエストクエリが高速
- [ ] インデックスが適切に設定されている

### ✅ エラーハンドリング確認

#### ネットワークエラー
- [ ] オフライン時の挙動が適切
- [ ] エラーメッセージが表示される
- [ ] リトライ可能

#### 権限エラー
- [ ] 通知許可がない場合でも動作
- [ ] Firestore権限エラーが適切に処理される

#### バリデーション
- [ ] メッセージが200文字を超えない
- [ ] 空のuserIdでエラーが発生しない

### ✅ UX確認

#### 操作性
- [ ] ボタンのタップ領域が適切
- [ ] スクロールが滑らか
- [ ] ダイアログの表示・非表示がスムーズ

#### フィードバック
- [ ] 操作後に適切なスナックバー表示
- [ ] ローディング中のUI表示
- [ ] エラー時の分かりやすいメッセージ

#### デザイン
- [ ] 全体的なデザイン統一性
- [ ] グラデーションボタンの美しさ
- [ ] テキストの可読性
- [ ] アイコンの適切な使用

---

## エラーケーステスト

### 🔴 エラーケース1: ネットワークエラー

**テスト手順:**
1. デバイスの機内モードをON
2. リクエストを送信
3. 機内モードをOFF

**期待される動作:**
- エラーメッセージ表示
- リトライ可能な状態
- オンライン復帰後に正常動作

**確認項目:**
- [ ] エラーメッセージが表示される
- [ ] アプリがクラッシュしない
- [ ] オンライン復帰後に正常動作

### 🔴 エラーケース2: Firestoreルール違反

**テスト手順:**
1. Firestoreのセキュリティルールを一時的に制限
2. リクエストを送信

**期待される動作:**
- 適切なエラーメッセージ表示
- アプリがクラッシュしない

**確認項目:**
- [ ] エラーメッセージが表示される
- [ ] アプリがクラッシュしない

### 🔴 エラーケース3: 通知送信失敗

**テスト手順:**
1. FCMトークンが無効なユーザーにリクエスト送信

**期待される動作:**
- リクエスト送信は成功
- 通知送信エラーは握りつぶす（ログのみ）
- ユーザーには成功メッセージ

**確認項目:**
- [ ] リクエスト送信が成功する
- [ ] エラーダイアログが表示されない
- [ ] ログにエラーが記録される

### 🔴 エラーケース4: ユーザー情報取得失敗

**テスト手順:**
1. 削除済みユーザーからのリクエストを開く

**期待される動作:**
- デフォルトのユーザー情報表示
- または適切なエラー表示

**確認項目:**
- [ ] アプリがクラッシュしない
- [ ] 適切なフォールバック表示

---

## 通知機能テスト

### 📲 通知テスト1: リクエスト送信通知

**テスト環境:**
- ユーザーA（送信者）: デバイス1
- ユーザーB（受信者）: デバイス2

**テスト手順:**
1. ユーザーBのデバイス2でアプリをバックグラウンドにする
2. ユーザーAがリクエストを送信（メッセージあり）
3. デバイス2の通知を確認

**期待される動作:**
- ✅ 通知が表示される
- ✅ タイトル: ユーザーAの名前
- ✅ 本文: 入力したメッセージ
- ✅ アイコン: アプリアイコン
- ✅ 通知音が鳴る

**確認項目:**
- [ ] 通知が表示される
- [ ] タイトルが正しい
- [ ] 本文が正しい
- [ ] タップでアプリが開く

### 📲 通知テスト2: リクエスト承認通知

**テスト手順:**
1. ユーザーAのデバイス1でアプリをバックグラウンドにする
2. ユーザーBがリクエストを承認
3. デバイス1の通知を確認

**期待される動作:**
- ✅ 通知が表示される
- ✅ タイトル: ユーザーBの名前
- ✅ 本文: "チャットリクエストが承認されました。"
- ✅ アイコン: アプリアイコン
- ✅ 通知音が鳴る

**確認項目:**
- [ ] 通知が表示される
- [ ] タイトルが正しい
- [ ] 本文が正しい
- [ ] タップでアプリが開く

### 📲 通知テスト3: マルチデバイス対応

**テスト環境:**
- ユーザーB: デバイス2（iPhone）
- ユーザーB: デバイス3（iPad）

**テスト手順:**
1. ユーザーBが両デバイスでログイン
2. ユーザーAがリクエストを送信
3. 両デバイスで通知を確認

**期待される動作:**
- ✅ デバイス2に通知が届く
- ✅ デバイス3に通知が届く
- ✅ 両方のデバイスで同じ内容

**確認項目:**
- [ ] 全デバイスに通知が届く
- [ ] 通知内容が同じ

### 📲 通知テスト4: 通知許可なし

**テスト手順:**
1. ユーザーBのデバイスで通知許可をOFF
2. ユーザーAがリクエストを送信

**期待される動作:**
- ✅ 通知は届かない
- ✅ リクエスト送信は成功
- ✅ リクエスト一覧には表示される

**確認項目:**
- [ ] 通知が届かない
- [ ] リクエスト機能は正常動作
- [ ] エラーメッセージなし

---

## 既知の制約・注意事項

### 制約事項
1. **メッセージ文字数制限**: 最大200文字
2. **リクエスト有効期限**: なし（明示的な有効期限は未実装）
3. **リクエスト数制限**: なし（スパム対策は未実装）
4. **通知リトライ**: なし（失敗時は握りつぶす）

### 注意事項
1. **却下時の通知**: プライバシー保護のため、却下時は送信者に通知されない
2. **通知エラー**: 通知送信失敗はログのみ、リクエスト送信は成功とする
3. **Firestoreインデックス**: 以下のインデックスが必要
   ```
   Collection: chat_requests
   Fields:
     - toUserId (Ascending)
     - status (Ascending)
     - createdAt (Descending)

   Collection: chat_requests
   Fields:
     - fromUserId (Ascending)
     - status (Ascending)
     - createdAt (Descending)
   ```
4. **マルチデバイス対応**: UserAccount.activeDevices が空の場合はフォールバック（fcmToken使用）

### パフォーマンス考慮事項
1. **リアルタイム更新**: Firestoreのストリームを使用（リアルタイム課金注意）
2. **通知送信**: Cloud Functionsまたはサーバー経由を推奨（本実装ではクライアント送信）
3. **ユーザー情報キャッシュ**: AllUsersNotifier を活用してAPI呼び出しを削減

---

## Firestoreセキュリティルール（推奨）

```javascript
match /chat_requests/{requestId} {
  // リクエストの作成: 自分が送信者の場合のみ
  allow create: if request.auth != null
    && request.resource.data.fromUserId == request.auth.uid
    && request.resource.data.status == 'pending';

  // リクエストの読み取り: 送信者または受信者
  allow read: if request.auth != null
    && (resource.data.fromUserId == request.auth.uid
        || resource.data.toUserId == request.auth.uid);

  // リクエストの更新: 受信者が承認する場合のみ
  allow update: if request.auth != null
    && resource.data.toUserId == request.auth.uid
    && request.resource.data.status == 'accepted';

  // リクエストの削除: 送信者または受信者
  allow delete: if request.auth != null
    && (resource.data.fromUserId == request.auth.uid
        || resource.data.toUserId == request.auth.uid);
}
```

---

## トラブルシューティング

### 問題: 通知が届かない
**チェック項目:**
1. 通知許可が有効か？
2. FCMトークンが正しく登録されているか？
3. Firebase Console で FCM が有効か？
4. デバイスがインターネットに接続されているか？

### 問題: リクエストが表示されない
**チェック項目:**
1. Firestoreのステータスが "pending" か？
2. Firestoreのクエリが正しいか？
3. ユーザーIDが正しいか？

### 問題: リアルタイム更新が動作しない
**チェック項目:**
1. Firestoreのストリームが正しく設定されているか？
2. Provider がリビルドされているか？
3. 画面がマウントされているか？

---

## テスト完了チェック

### 全体確認
- [ ] 全テストケースを実施
- [ ] 全確認項目をチェック
- [ ] エラーケースを確認
- [ ] 通知機能を確認
- [ ] パフォーマンスを確認

### レポート作成
- [ ] テスト結果をまとめる
- [ ] 発見したバグをリスト化
- [ ] 改善提案をまとめる

---

## 補足資料

### 関連ファイル一覧
```
lib/
├── domain/
│   ├── entity/
│   │   └── chat_request.dart
│   └── usecases/
│       ├── chat_request_usecase.dart
│       └── push_notification_usecase.dart
├── data/
│   ├── datasource/
│   │   └── chat_request_datasource.dart
│   └── repository/
│       └── chat_request_repository.dart
└── presentation/
    ├── pages/
    │   └── chat_request/
    │       ├── chat_request_list_screen.dart
    │       └── send_chat_request_helper.dart
    └── providers/
        └── chat_requests/
            ├── received_requests_notifier.dart
            ├── sent_requests_notifier.dart
            └── pending_request_count_provider.dart
```

### 参考リンク
- [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Riverpod Documentation](https://riverpod.dev/)

---

**作成日:** 2025年（記録用）
**バージョン:** 1.3.0
**作成者:** Claude Code
**最終更新:** 2025年10月9日
